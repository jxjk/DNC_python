# 03_系统开发详细文档 - 补充内容

## 12. 技术架构设计（基于VB.NET源码分析的核心类设计）

### 12.1 系统架构概述

基于VB.NET源码分析，DNC系统采用分层架构设计，主要分为以下层次：

- **表示层**：用户界面和交互控制
- **业务逻辑层**：计算引擎和数据处理
- **数据访问层**：文件系统和数据库操作
- **通信层**：NC机床和进程间通信

### 12.2 核心类设计

#### 12.2.1 DNCMainApplication（主应用类）

**职责**：系统入口点和协调中心

**核心方法**：
```python
class DNCMainApplication:
    def __init__(self):
        self.config_manager = ConfigManager()
        self.data_manager = DataManager()
        self.ui_manager = UIManager()
        self.calculation_engine = CalculationEngine()
        self.communication_manager = CommunicationManager()
    
    def initialize_system(self):
        """系统初始化流程"""
        # 1. 加载配置文件
        self.config_manager.load_config_files()
        # 2. 加载数据文件
        self.data_manager.load_data_files()
        # 3. 创建用户界面
        self.ui_manager.create_interface()
        # 4. 初始化通信连接
        self.communication_manager.initialize_connections()
    
    def start_application(self):
        """启动应用程序"""
        self.initialize_system()
        self.ui_manager.show_main_window()
    
    def shutdown_application(self):
        """关闭应用程序"""
        self.communication_manager.close_connections()
        self.data_manager.save_changes()
        self.config_manager.save_config_changes()
```

**对应VB.NET方法**：
- `Frm_main_Load()` - 系统初始化
- `Frm_main_Shown()` - 界面显示
- `Frm_main_Closing()` - 系统关闭

#### 12.2.2 ConfigManager（配置管理类）

**职责**：管理所有配置文件和系统设置

**核心方法**：
```python
class ConfigManager:
    def load_config_files(self):
        """加载所有配置文件"""
        # 加载INI配置文件
        self.load_ini_config()
        # 加载程序配置
        self.load_prg_config()
        # 加载类型定义
        self.load_type_definitions()
    
    def load_ini_config(self):
        """加载INI配置（对应VB.NET setIni方法）"""
        # 实现INI文件解析逻辑
        pass
    
    def load_prg_config(self):
        """加载程序配置（对应VB.NET setPRG方法）"""
        # 实现程序配置加载逻辑
        pass
```

#### 12.2.3 DataManager（数据管理类）

**职责**：管理所有数据文件的加载、搜索和更新

**核心方法**：
```python
class DataManager:
    def load_data_files(self):
        """加载所有数据文件（对应VB.NET LoadFileToTBL方法）"""
        # 加载关系数据表
        self.load_relation_tables()
        # 加载计算数据表
        self.load_calc_tables()
        # 加载类型定义表
        self.load_type_tables()
    
    def search_table(self, table_name, condition):
        """搜索数据表（对应VB.NET searchT_*方法）"""
        # 实现通用搜索逻辑
        pass
    
    def get_relation_data(self, relation_id):
        """获取关系数据（对应VB.NET setRelationTBL方法）"""
        # 实现关系数据获取逻辑
        pass
```

#### 12.2.4 UIManager（界面管理类）

**职责**：管理用户界面的创建、更新和交互

**核心方法**：
```python
class UIManager:
    def create_interface(self):
        """创建用户界面（对应VB.NET setControls方法）"""
        # 创建主窗口
        self.main_window = MainWindow()
        # 创建控件工厂
        self.control_factory = ControlFactory()
        # 创建事件处理器
        self.event_handler = EventHandler()
        
        # 创建8种核心控件系统
        self.create_load_controls()
        self.create_input_controls()
        self.create_measure_controls()
        self.create_select_controls()
        self.create_relation_controls()
        self.create_switch_controls()
        self.create_correct_controls()
        self.create_add_controls()
    
    def update_display(self):
        """更新显示（对应VB.NET dispTargetPRG方法）"""
        # 更新界面显示状态
        pass
```

#### 12.2.5 ControlFactory（控件工厂类）

**职责**：创建和管理各种界面控件

**核心方法**：
```python
class ControlFactory:
    def create_load_control(self, config):
        """创建加载控件（对应VB.NET makeCntrlLoad方法）"""
        # 实现加载控件创建逻辑
        pass
    
    def create_input_control(self, config):
        """创建输入控件（对应VB.NET makeCntrlInput方法）"""
        # 实现输入控件创建逻辑
        pass
    
    def create_measure_control(self, config):
        """创建测量控件（对应VB.NET makeCntrlMeasure方法）"""
        # 实现测量控件创建逻辑
        pass
    
    # 其他控件创建方法...
```

#### 12.2.6 CalculationEngine（计算引擎类）

**职责**：执行数学计算和逻辑判断

**核心方法**：
```python
class CalculationEngine:
    def calculate_expression(self, expression, variables):
        """计算表达式（对应VB.NET getCalcResult方法）"""
        # 实现表达式计算逻辑
        pass
    
    def evaluate_condition(self, condition, variables):
        """评估条件（对应VB.NET judgeRelation方法）"""
        # 实现条件判断逻辑
        pass
    
    def process_relation_logic(self, relation_config):
        """处理关系逻辑（对应VB.NET setValueForRelationCondition方法）"""
        # 实现关系逻辑处理
        pass
```

### 12.3 8种核心控件系统架构设计

#### 12.3.1 Load控件系统架构

**设计模式**：工厂模式 + 观察者模式

**核心组件**：
- `LoadControlFactory`：加载控件工厂
- `LoadDataProvider`：数据提供者
- `LoadEventHandler`：事件处理器

**数据流**：
```
数据源 → LoadDataProvider → LoadControl → 界面显示
```

#### 12.3.2 Input控件系统架构

**设计模式**：策略模式 + 命令模式

**核心组件**：
- `InputStrategy`：输入策略接口
- `KeyboardInput`：键盘输入策略
- `CalculatorInput`：计算器输入策略
- `InputCommand`：输入命令对象

#### 12.3.3 Measure控件系统架构

**设计模式**：状态模式 + 装饰器模式

**核心组件**：
- `MeasureState`：测量状态接口
- `NormalState`：正常状态
- `WarningState`：警告状态
- `ErrorState`：错误状态
- `MeasureDecorator`：测量装饰器

#### 12.3.4 Select控件系统架构

**设计模式**：组合模式 + 迭代器模式

**核心组件**：
- `SelectItem`：选择项接口
- `SelectGroup`：选择项组
- `SelectIterator`：选择项迭代器

#### 12.3.5 Relation控件系统架构

**设计模式**：中介者模式 + 责任链模式

**核心组件**：
- `RelationMediator`：关系中介者
- `RelationHandler`：关系处理器
- `ConditionChain`：条件处理链

#### 12.3.6 Switch控件系统架构

**设计模式**：状态模式 + 备忘录模式

**核心组件**：
- `SwitchState`：开关状态接口
- `SwitchContext`：开关上下文
- `SwitchMemento`：开关状态备忘录

#### 12.3.7 Correct控件系统架构

**设计模式**：命令模式 + 访问者模式

**核心组件**：
- `CorrectCommand`：校正命令接口
- `CorrectVisitor`：校正访问者
- `CorrectHistory`：校正历史记录

#### 12.3.8 Add控件系统架构

**设计模式**：建造者模式 + 原型模式

**核心组件**：
- `ControlGroupBuilder`：控件组建造者
- `ControlGroupDirector`：控件组指导者
- `ControlPrototype`：控件原型

### 12.4 计算引擎架构设计

#### 12.4.1 表达式解析器设计

**核心组件**：
- `ExpressionLexer`：词法分析器
- `ExpressionParser`：语法分析器
- `ExpressionEvaluator`：表达式求值器

**解析流程**：
```
原始表达式 → 词法分析 → 语法分析 → 抽象语法树 → 求值计算 → 结果
```

#### 12.4.2 数学函数库设计

**函数分类**：
- 基础数学函数：`SIN`, `COS`, `TAN`
- 统计函数：`MAX`, `MIN`, `AVG`
- 舍入函数：`ROUND`, `CEILING`, `FLOOR`
- 自定义函数：支持用户定义

#### 12.4.3 条件判断引擎设计

**条件类型**：
- 数值比较条件
- 字符串匹配条件
- 逻辑组合条件
- 范围检查条件

### 12.5 通信模块架构设计

#### 12.5.1 NC机床通信设计

**协议支持**：
- Rexroth协议
- Brother协议
- 自定义协议

**通信管理**：
- 连接池管理
- 消息队列管理
- 错误重试机制

#### 12.5.2 进程间通信设计

**通信方式**：
- 命名管道通信
- 共享内存通信
- 消息队列通信

## 13. 数据处理流程（基于VB.NET业务流程的完整处理流程）

### 13.1 系统初始化数据处理流程

#### 13.1.1 配置加载流程

**流程步骤**：
1. **加载INI配置文件**
   - 读取系统基本配置
   - 设置界面参数
   - 初始化通信设置

2. **加载程序配置**
   - 读取程序定义文件
   - 设置程序参数
   - 初始化程序状态

3. **加载类型定义**
   - 读取类型定义表
   - 建立类型关系映射
   - 初始化类型转换规则

**数据流图**：
```
INI配置文件 → ConfigManager → 系统配置
PRG配置文件 → ConfigManager → 程序配置
类型定义文件 → ConfigManager → 类型定义
```

#### 13.1.2 数据文件加载流程

**流程步骤**：
1. **加载关系数据表**
   - 读取T_relation.csv
   - 建立关系数据索引
   - 缓存关系数据

2. **加载计算数据表**
   - 读取T_calc.csv
   - 建立计算规则索引
   - 缓存计算数据

3. **加载类型数据表**
   - 读取type_define.csv
   - 读取type_relation.csv
   - 读取type_chngvl.csv

**数据流图**：
```
CSV数据文件 → CSVProcessor → DataManager → 内存数据表
```

### 13.2 Master数据加载流程

#### 13.2.1 主数据加载流程

**流程步骤**：
1. **读取Master数据文件**
   - 加载header.csv（头部定义）
   - 加载ini.csv（初始化数据）
   - 加载type_*.csv（类型定义）

2. **数据验证和转换**
   - 验证数据完整性
   - 转换数据格式
   - 建立数据索引

3. **缓存管理**
   - 内存缓存数据表
   - 建立快速搜索索引
   - 数据版本管理

**详细流程**：
```python
def load_master_data(self):
    """Master数据加载流程"""
    # 1. 加载头部定义
    header_data = self.csv_processor.read_csv('data/master/header.csv')
    
    # 2. 加载初始化数据
    ini_data = self.csv_processor.read_csv('data/master/ini.csv')
    
    # 3. 加载类型定义
    type_define = self.csv_processor.read_csv('data/master/type_define.csv')
    type_relation = self.csv_processor.read_csv('data/master/type_relation.csv')
    type_chngvl = self.csv_processor.read_csv('data/master/type_chngvl.csv')
    
    # 4. 数据验证
    self.validate_master_data(header_data, ini_data, type_define)
    
    # 5. 建立索引
    self.build_data_indexes()
    
    # 6. 缓存数据
    self.cache_master_data()
```

#### 13.2.2 程序数据加载流程

**流程步骤**：
1. **选择程序目录**
   - 根据程序编号选择prg1/prg2/prg3
   - 加载程序配置文件

2. **加载程序数据文件**
   - 加载add.csv（添加数据）
   - 加载calc.csv（计算数据）
   - 加载chngValue.csv（变更值数据）
   - 加载cntrl.csv（控制数据）
   - 加载correct.csv（校正数据）
   - 加载define.csv（定义数据）
   - 加载input.csv（输入数据）
   - 加载load.csv（加载数据）
   - 加载measure.csv（测量数据）
   - 加载preset.csv（预设数据）
   - 加载relation.csv（关系数据）
   - 加载select.csv（选择数据）
   - 加载switch.csv（开关数据）

3. **数据关联和验证**
   - 建立程序内数据关联
   - 验证数据一致性
   - 初始化程序状态

### 13.3 实时计算处理流程

#### 13.3.1 用户输入处理流程

**流程步骤**：
1. **输入事件触发**
   - 文本框变更事件
   - 按钮点击事件
   - 组合框选择事件

2. **数据验证**
   - 数值格式验证
   - 数据范围检查
   - 业务规则验证

3. **相关数据搜索**
   - 搜索关系数据
   - 搜索计算规则
   - 搜索类型定义

4. **计算执行**
   - 表达式计算
   - 条件判断
   - 结果验证

5. **界面更新**
   - 更新相关控件值
   - 刷新界面显示
   - 状态提示更新

**详细流程**：
```python
def handle_user_input(self, control_id, input_value):
    """用户输入处理流程"""
    # 1. 验证输入数据
    if not self.validate_input(control_id, input_value):
        return
    
    # 2. 搜索相关定义
    relation_config = self.search_relation_config(control_id)
    calc_config = self.search_calc_config(control_id)
    
    # 3. 执行计算
    if calc_config:
        result = self.calculation_engine.calculate(
            calc_config.expression, 
            {'@INPUT': input_value}
        )
    
    # 4. 更新相关控件
    if relation_config:
        self.update_related_controls(relation_config, result)
    
    # 5. 刷新界面
    self.ui_manager.refresh_display()
```

#### 13.3.2 关系数据处理流程

**流程步骤**：
1. **关系条件判断**
   - 获取关系条件配置
   - 收集相关变量值
   - 执行条件判断

2. **值转换处理**
   - 搜索变更值表
   - 执行值转换规则
   - 验证转换结果

3. **目标控件更新**
   - 设置目标控件值
   - 更新控件状态
   - 触发相关事件

**详细流程**：
```python
def process_relation_data(self, source_control, source_value):
    """关系数据处理流程"""
    # 1. 搜索关系配置
    relation_configs = self.data_manager.search_relation_configs(source_control)
    
    for config in relation_configs:
        # 2. 收集相关变量
        variables = self.collect_relation_variables(config)
        
        # 3. 条件判断
        condition_result = self.calculation_engine.evaluate_condition(
            config.condition, variables
        )
        
        if condition_result:
            # 4. 值转换
            target_value = self.data_manager.search_chng_value(
                source_value, config.define
            )
            
            # 5. 更新目标控件
            self.ui_manager.set_control_value(
                config.target_control, target_value
            )
```

### 13.4 数据持久化流程

#### 13.4.1 配置保存流程

**流程步骤**：
1. **收集配置变更**
   - 界面设置变更
   - 计算参数变更
   - 通信设置变更

2. **数据验证**
   - 配置完整性检查
   - 参数范围验证
   - 依赖关系验证

3. **文件写入**
   - 写入INI配置文件
   - 写入程序配置文件
   - 写入类型定义文件

#### 13.4.2 数据备份流程

**流程步骤**：
1. **创建备份目录**
   - 按时间戳创建备份
   - 保留历史版本

2. **数据导出**
   - 导出配置数据
   - 导出程序数据
   - 导出计算数据

3. **备份验证**
   - 验证备份完整性
   - 检查数据一致性
   - 生成备份报告

### 13.5 错误处理和恢复流程

#### 13.5.1 数据错误处理流程

**错误类型**：
- 文件不存在错误
- 数据格式错误
- 数据验证错误

**处理流程**：
1. **错误检测**
   - 文件访问错误检测
   - 数据解析错误检测
   - 业务规则错误检测

2. **错误恢复**
   - 使用默认值恢复
   - 从备份文件恢复
   - 用户手动修复

3. **错误日志**
   - 记录错误详细信息
   - 生成错误报告
   - 发送错误通知
