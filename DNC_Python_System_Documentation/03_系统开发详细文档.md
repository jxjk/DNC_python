# DNC系统开发详细文档

## 1. 项目概述

### 1.1 系统简介
DNC（Direct Numerical Control）系统是一个数控设备参数管理软件，用于从电脑直接传送参数到NC机的宏变量系统。该系统解决了传统NC机手动输入参数的时间和错误问题。

### 1.2 系统架构
- **原系统**: VB.NET DNC2.05
- **新系统**: Python重写版本
- **系统构成**: PC + NC机 + LAN线 + DNC软件
- **数据格式**: CSV文件存储Master数据

## 2. 系统功能模块

### 2.1 核心功能模块

#### 2.1.1 产品型号管理
- 产品类型定义 (type_define.csv)
- 程序类型映射 (type_prg.csv)
- 产品参数配置 (load.csv)

#### 2.1.2 参数计算引擎
- 几何参数计算 (calc.csv)
- 关系验证逻辑 (relation.csv)
- 变量定义管理 (define.csv)

#### 2.1.3 程序生成器
- 程序定义 (prg.csv)
- 控制参数 (cntrl_rex.csv)
- 选择逻辑 (select.csv)

### 2.2 数据流处理

#### 2.2.1 输入处理
```python
输入 → 参数验证 → 计算引擎 → 程序生成 → 输出
```

#### 2.2.2 宏变量映射
- #500-#600: 系统参数
- #1-#100: 用户参数
- 特殊变量: 计算中间值

## 3. 数据结构详细说明

### 3.1 核心数据文件

#### 3.1.1 type_define.csv (产品类型定义)
- **文件大小**: 988.60 KB
- **数据结构**:
  - NO: 序号
  - TYPE: 产品型号 (如: GPA18GT15040-A)
  - DEFINE1: 定义1
  - DEFINE2: 定义2

#### 3.1.2 type_prg.csv (程序类型映射)
- **文件大小**: 480.92 KB
- **数据结构**:
  - NO: 序号
  - prg1: 程序1编号
  - prg2: 程序2编号

#### 3.1.3 load.csv (主数据文件)
- **文件大小**: 8.5 MB
- **数据结构**:
  - NO: 序号
  - TYPE: 产品型号
  - DRAWING: 图纸文件
  - DISPFLG: 显示标志
  - #1-#12: 定义变量
  - #500-#550: 系统参数
  - #602-#603: 开关控制

#### 3.1.4 cntrl_rex.csv (参数控制)
- **文件大小**: 1.10 KB
- **数据结构**:
  - PARAMETER: 参数名称 (如: Work_plan, Teeth_num)
  - DATATYPE: 数据类型 (int, real, boolean)
  - MACRO: 宏变量映射 (如: #510, #511)

### 3.2 计算逻辑文件

#### 3.2.1 calc.csv (计算定义)
```csv
DEFINE,1,2,3,4,5,6,7,8,9,10,11,12,13
calcABC,=,#528,-,#510,*,2,NaN,NaN,NaN,NaN,NaN,NaN,NaN
calcABCD,=,(,#528,-,#513,),/,2.0,NaN,NaN,NaN,NaN,NaN
```

#### 3.2.2 relation.csv (关系验证)
```csv
DEFINE,VALUE,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28
relationHPN,#1,and,#1,>,0.0,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN,NaN
```

#### 3.2.3 define.csv (变量定义)
```csv
DEFINE,STR,BEFORE,AFTER,CHNGVL,CALC
defineP,P,P0,0,NaN,NaN
defineH,H,H0,0,NaN,NaN
```

## 4. 技术架构设计

### 4.1 系统架构图

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   用户界面层     │    │   业务逻辑层     │    │   数据访问层     │
│                 │    │                 │    │                 │
│  - 主窗口       │◄──►│  - 参数计算     │◄──►│  - CSV处理器    │
│  - 输入表单     │    │  - 程序生成     │    │  - 数据验证     │
│  - 结果显示     │    │  - 关系验证     │    │  - 编码处理     │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 4.2 核心类设计

#### 4.2.1 DataManager (数据管理器)
```python
class DataManager:
    def load_master_data(self) -> Dict[str, pd.DataFrame]
    def batch_read_large_csv(self, file_path: str, batch_size: int = 1000)
    def validate_data_integrity(self) -> bool
    def fix_encoding_issues(self, file_path: str) -> pd.DataFrame
```

#### 4.2.2 CalculationEngine (计算引擎)
```python
class CalculationEngine:
    def calculate_parameters(self, input_data: Dict) -> Dict
    def validate_relations(self, calculated_data: Dict) -> bool
    def generate_macro_variables(self, params: Dict) -> List[str]
```

#### 4.2.3 ProgramGenerator (程序生成器)
```python
class ProgramGenerator:
    def generate_nc_program(self, product_type: str, params: Dict) -> str
    def apply_program_template(self, template: str, variables: Dict) -> str
    def validate_program_syntax(self, program: str) -> bool
```

## 5. 数据处理流程

### 5.1 数据加载流程
1. **扫描目录**: 递归扫描master目录下的所有CSV文件
2. **分类处理**: 根据文件大小分类为小文件和大文件
3. **编码检测**: 自动检测文件编码 (UTF-8, Shift-JIS, CP932)
4. **分批读取**: 大文件使用分批读取机制
5. **数据验证**: 检查数据完整性和一致性

### 5.2 参数计算流程
1. **输入验证**: 验证用户输入参数的有效性
2. **变量替换**: 根据define.csv进行变量替换
3. **计算执行**: 执行calc.csv中定义的计算逻辑
4. **关系验证**: 验证relation.csv中定义的关系条件
5. **结果生成**: 生成最终的宏变量值

## 6. 文件编码处理

### 6.1 编码问题文件列表
- `ini.csv`: 958字节，编码问题
- `math.csv`: 1.08KB，编码问题  
- `cntrl.csv`: 1.38KB，编码问题
- `switch.csv`: 106字节，编码问题

### 6.2 编码处理策略
```python
def detect_encoding(file_path: str) -> str:
    encodings = ['utf-8', 'shift_jis', 'cp932', 'latin1']
    for encoding in encodings:
        try:
            with open(file_path, 'r', encoding=encoding) as f:
                f.read()
            return encoding
        except UnicodeDecodeError:
            continue
    return 'unknown'
```

## 7. 性能优化策略

### 7.1 大文件处理优化
- **分批读取**: 使用pandas的chunksize参数
- **内存管理**: 及时释放不需要的数据
- **缓存机制**: 缓存频繁访问的数据

### 7.2 计算优化
- **预编译**: 预编译计算表达式
- **并行处理**: 使用多线程处理独立计算
- **结果缓存**: 缓存重复计算结果

## 8. 错误处理机制

### 8.1 数据验证错误
- 文件不存在错误
- 编码错误处理
- 数据格式错误
- 完整性检查失败

### 8.2 计算错误
- 除零错误处理
- 变量未定义错误
- 关系验证失败
- 程序生成错误

## 9. 部署和配置

### 9.1 环境要求
- Python 3.8+
- pandas >= 1.3.0
- PyQt5/PySide6
- 操作系统: Windows 10/11

### 9.2 配置文件
```ini
[system]
data_directory = ./data/master
log_level = INFO
batch_size = 1000

[encoding]
default_encoding = utf-8
fallback_encodings = shift_jis,cp932,latin1
```

## 10. 测试策略

### 10.1 单元测试
- 数据加载测试
- 计算逻辑测试
- 程序生成测试
- 错误处理测试

### 10.2 集成测试
- 端到端流程测试
- 性能测试
- 兼容性测试

## 11. 维护和扩展

### 11.1 数据维护
- 定期备份Master数据
- 数据完整性检查
- 版本控制支持

### 11.2 功能扩展
- 支持新的产品类型
- 添加新的计算逻辑
- 扩展程序模板

---

**文档版本**: 1.0  
**最后更新**: 2025/10/23  
**维护者**: DNC开发团队
