# DNC参数计算系统 - 部署和维护文档

## 部署概述

### 部署目标
确保DNC参数计算系统在生产环境中稳定运行，提供可靠的参数计算和程序生成服务。

### 部署环境要求
- **生产服务器**: Windows Server 2019+ 或 Linux CentOS 7+
- **数据库**: SQLite (内置) 或 PostgreSQL (可选)
- **网络**: 稳定的局域网连接
- **存储**: 至少10GB可用空间
- **备份**: 定期备份机制

## 部署方案

### 方案一：单机部署

#### 部署步骤
1. **环境准备**
   ```bash
   # 安装Python 3.8+
   # 安装必要的系统依赖
   # 创建部署目录
   mkdir /opt/dnc_system
   cd /opt/dnc_system
   ```

2. **程序部署**
   ```bash
   # 复制程序文件
   cp -r DNC_Python_Project/* /opt/dnc_system/
   
   # 设置权限
   chmod +x run.sh
   chown -R dnc:dnc /opt/dnc_system
   ```

3. **数据初始化**
   ```bash
   # 创建数据目录
   mkdir -p data/master data/input output logs
   
   # 导入Master数据
   cp -r /path/to/master/data/* data/master/
   ```

4. **服务配置**
   ```bash
   # 创建系统服务
   sudo cp dnc_system.service /etc/systemd/system/
   sudo systemctl daemon-reload
   sudo systemctl enable dnc_system
   ```

#### 服务配置文件
`/etc/systemd/system/dnc_system.service`
```ini
[Unit]
Description=DNC参数计算系统
After=network.target

[Service]
Type=simple
User=dnc
Group=dnc
WorkingDirectory=/opt/dnc_system
ExecStart=/usr/bin/python3 main.py
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
```

### 方案二：集群部署

#### 架构设计
```
负载均衡器 (Nginx)
    |
    +-- 应用服务器 1 (DNC System)
    +-- 应用服务器 2 (DNC System)
    +-- 应用服务器 3 (DNC System)
    |
    +-- 共享存储 (NFS)
    +-- 数据库服务器 (PostgreSQL)
```

#### 部署步骤
1. **共享存储配置**
   ```bash
   # NFS服务器配置
   # /etc/exports
   /opt/dnc_shared 192.168.1.0/24(rw,sync,no_subtree_check)
   ```

2. **应用服务器配置**
   ```bash
   # 挂载共享存储
   mount -t nfs 192.168.1.100:/opt/dnc_shared /opt/dnc_system
   
   # 安装应用
   cp -r DNC_Python_Project/* /opt/dnc_system/
   ```

3. **负载均衡配置**
   ```nginx
   # nginx.conf
   upstream dnc_servers {
       server 192.168.1.101:8000;
       server 192.168.1.102:8000;
       server 192.168.1.103:8000;
   }
   
   server {
       listen 80;
       server_name dnc.example.com;
       
       location / {
           proxy_pass http://dnc_servers;
           proxy_set_header Host $host;
           proxy_set_header X-Real-IP $remote_addr;
       }
   }
   ```

### 方案三：容器化部署

#### Docker配置
`Dockerfile`
```dockerfile
FROM python:3.8-slim

WORKDIR /app

# 安装系统依赖
RUN apt-get update && apt-get install -y \
    gcc \
    && rm -rf /var/lib/apt/lists/*

# 复制程序文件
COPY requirements.txt .
RUN pip install -r requirements.txt

COPY . .

# 创建数据目录
RUN mkdir -p data/master data/input output logs

# 设置权限
RUN useradd -m dnc && chown -R dnc:dnc /app

USER dnc

EXPOSE 8000

CMD ["python", "main.py"]
```

#### Docker Compose配置
`docker-compose.yml`
```yaml
version: '3.8'

services:
  dnc-system:
    build: .
    ports:
      - "8000:8000"
    volumes:
      - dnc_data:/app/data
      - dnc_logs:/app/logs
    environment:
      - PYTHONUNBUFFERED=1
    restart: unless-stopped

volumes:
  dnc_data:
  dnc_logs:
```

#### 部署命令
```bash
# 构建和启动
docker-compose up -d

# 查看状态
docker-compose ps

# 查看日志
docker-compose logs -f
```

## 配置管理

### 生产环境配置
`config/production.ini`
```ini
[APPLICATION]
name = DNC参数计算系统
version = 2.05
environment = production
debug = false
log_level = INFO

[DATABASE]
type = sqlite
path = data/dnc_system.db
backup_enabled = true
backup_interval = 24

[PATHS]
master_directory = data/master
input_directory = data/input
output_directory = output
log_directory = logs
backup_directory = backups

[SECURITY]
encryption_enabled = true
session_timeout = 3600
max_login_attempts = 5

[PERFORMANCE]
max_workers = 4
cache_size = 1000
batch_size = 100
```

### 环境变量配置
```bash
# 环境变量文件 .env
DNC_ENVIRONMENT=production
DNC_DB_PATH=/opt/dnc_system/data/dnc_system.db
DNC_LOG_LEVEL=INFO
DNC_MAX_WORKERS=4
```

## 监控和日志

### 系统监控

#### 监控指标
- **CPU使用率**: 不超过80%
- **内存使用**: 不超过2GB
- **磁盘空间**: 剩余空间 > 1GB
- **响应时间**: API响应 < 1秒
- **错误率**: 错误请求 < 1%

#### 监控脚本
`scripts/monitor_system.py`
```python
#!/usr/bin/env python3
import psutil
import requests
import logging
from datetime import datetime

def check_system_health():
    """检查系统健康状态"""
    alerts = []
    
    # 检查CPU
    cpu_percent = psutil.cpu_percent(interval=1)
    if cpu_percent > 80:
        alerts.append(f"CPU使用率过高: {cpu_percent}%")
    
    # 检查内存
    memory = psutil.virtual_memory()
    if memory.percent > 85:
        alerts.append(f"内存使用率过高: {memory.percent}%")
    
    # 检查磁盘
    disk = psutil.disk_usage('/')
    if disk.percent > 90:
        alerts.append(f"磁盘空间不足: {disk.percent}%")
    
    # 检查应用服务
    try:
        response = requests.get('http://localhost:8000/health', timeout=5)
        if response.status_code != 200:
            alerts.append("应用服务异常")
    except:
        alerts.append("应用服务不可达")
    
    return alerts

if __name__ == "__main__":
    alerts = check_system_health()
    if alerts:
        logging.warning(f"系统告警: {alerts}")
        # 发送告警通知
```

### 日志管理

#### 日志配置
`config/logging.ini`
```ini
[loggers]
keys=root,dnc_system

[handlers]
keys=file_handler,console_handler

[formatters]
keys=standard_formatter

[logger_root]
level=INFO
handlers=console_handler

[logger_dnc_system]
level=INFO
handlers=file_handler,console_handler
qualname=dnc_system
propagate=0

[handler_file_handler]
class=handlers.TimedRotatingFileHandler
level=INFO
formatter=standard_formatter
args=('logs/dnc_system.log', 'midnight', 1, 30)

[handler_console_handler]
class=StreamHandler
level=INFO
formatter=standard_formatter
args=(sys.stdout,)

[formatter_standard_formatter]
format=%(asctime)s - %(name)s - %(levelname)s - %(message)s
datefmt=%Y-%m-%d %H:%M:%S
```

#### 日志轮转配置
```bash
# /etc/logrotate.d/dnc_system
/opt/dnc_system/logs/*.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    create 644 dnc dnc
    postrotate
        systemctl reload dnc_system
    endscript
}
```

## 备份和恢复

### 备份策略

#### 数据备份
```bash
#!/bin/bash
# scripts/backup_system.sh

BACKUP_DIR="/opt/dnc_backups"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="dnc_backup_${DATE}.tar.gz"

# 创建备份目录
mkdir -p $BACKUP_DIR

# 停止服务
systemctl stop dnc_system

# 备份数据
tar -czf $BACKUP_DIR/$BACKUP_FILE \
    /opt/dnc_system/data \
    /opt/dnc_system/config \
    /opt/dnc_system/logs

# 启动服务
systemctl start dnc_system

# 清理旧备份 (保留最近30天)
find $BACKUP_DIR -name "dnc_backup_*.tar.gz" -mtime +30 -delete

echo "备份完成: $BACKUP_DIR/$BACKUP_FILE"
```

#### 数据库备份
```python
# scripts/backup_database.py
import sqlite3
import shutil
from datetime import datetime

def backup_database():
    """备份SQLite数据库"""
    source_db = "data/dnc_system.db"
    backup_dir = "backups/database"
    
    # 创建备份目录
    os.makedirs(backup_dir, exist_ok=True)
    
    # 生成备份文件名
    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    backup_file = f"{backup_dir}/dnc_db_{timestamp}.db"
    
    # 执行备份
    shutil.copy2(source_db, backup_file)
    
    # 清理旧备份 (保留最近7天)
    cleanup_old_backups(backup_dir, days=7)
    
    return backup_file
```

### 恢复流程

#### 数据恢复
```bash
#!/bin/bash
# scripts/restore_system.sh

BACKUP_FILE=$1

if [ -z "$BACKUP_FILE" ]; then
    echo "请指定备份文件"
    exit 1
fi

# 停止服务
systemctl stop dnc_system

# 恢复数据
tar -xzf $BACKUP_FILE -C /opt/dnc_system

# 启动服务
systemctl start dnc_system

echo "系统恢复完成"
```

#### 数据库恢复
```python
# scripts/restore_database.py
import sqlite3
import shutil

def restore_database(backup_file):
    """恢复数据库"""
    target_db = "data/dnc_system.db"
    
    # 停止应用服务
    stop_application()
    
    try:
        # 备份当前数据库
        shutil.copy2(target_db, f"{target_db}.backup")
        
        # 恢复数据库
        shutil.copy2(backup_file, target_db)
        
        # 启动应用服务
        start_application()
        
        print("数据库恢复成功")
        
    except Exception as e:
        # 恢复失败，回滚
        shutil.copy2(f"{target_db}.backup", target_db)
        print(f"数据库恢复失败: {e}")
```

## 维护操作

### 日常维护

#### 健康检查
```bash
#!/bin/bash
# scripts/daily_health_check.sh

# 检查服务状态
systemctl status dnc_system

# 检查磁盘空间
df -h /opt/dnc_system

# 检查日志文件大小
find /opt/dnc_system/logs -name "*.log" -size +100M

# 检查备份状态
ls -la /opt/dnc_backups/
```

#### 日志清理
```bash
#!/bin/bash
# scripts/cleanup_logs.sh

# 清理30天前的日志
find /opt/dnc_system/logs -name "*.log.*" -mtime +30 -delete

# 清理临时文件
find /opt/dnc_system/tmp -name "*" -mtime +7 -delete

# 清理缓存文件
find /opt/dnc_system/cache -name "*" -mtime +1 -delete
```

### 定期维护

#### 月度维护任务
1. **数据库优化**
   ```sql
   -- SQLite数据库优化
   VACUUM;
   ANALYZE;
   ```

2. **系统更新**
   ```bash
   # 更新系统包
   apt-get update && apt-get upgrade
   
   # 更新Python包
   pip install -r requirements.txt --upgrade
   ```

3. **安全扫描**
   ```bash
   # 检查文件权限
   find /opt/dnc_system -type f -perm /o=w
   
   # 检查可疑进程
   ps aux | grep dnc_system
   ```

## 故障排除

### 常见问题解决

#### 问题1: 服务无法启动
**症状**: systemctl status 显示服务失败
**解决步骤**:
1. 检查日志: `journalctl -u dnc_system`
2. 检查端口占用: `netstat -tulpn | grep 8000`
3. 检查文件权限: `ls -la /opt/dnc_system/`
4. 检查依赖: `pip list | grep -E "(pandas|numpy)"`

#### 问题2: 计算性能下降
**症状**: 计算响应时间变慢
**解决步骤**:
1. 检查系统资源: `top`, `free -h`
2. 检查数据库大小: `du -sh data/dnc_system.db`
3. 优化数据库: `sqlite3 data/dnc_system.db "VACUUM;"`
4. 清理缓存: `rm -rf cache/*`

#### 问题3: 数据文件损坏
**症状**: 数据加载失败或计算错误
**解决步骤**:
1. 验证数据完整性: `python -c "from src.data.data_manager import DataManager; dm = DataManager(); print(dm.validate_data_integrity())"`
2. 修复编码问题: `python -c "from src.data.csv_processor import CSVProcessor; cp = CSVProcessor(); cp.fix_encoding_issues('data/master/load.csv')"`
3. 从备份恢复: 执行恢复脚本

### 紧急恢复流程

#### 系统完全故障
1. **立即行动**
   - 停止服务: `systemctl stop dnc_system`
   - 通知用户: 系统维护中
   - 备份当前状态

2. **恢复步骤**
   - 从最新备份恢复数据
   - 验证数据完整性
   - 启动服务
   - 测试核心功能

3. **事后分析**
   - 分析故障原因
   - 更新应急预案
   - 改进监控机制

## 安全考虑

### 安全配置

#### 文件权限
```bash
# 设置正确的文件权限
chown -R dnc:dnc /opt/dnc_system
chmod 750 /opt/dnc_system
chmod 640 /opt/dnc_system/config/*.ini
chmod 600 /opt/dnc_system/data/dnc_system.db
```

#### 网络安全
```bash
# 防火墙配置
ufw allow 22    # SSH
ufw allow 80    # HTTP (如果使用Web界面)
ufw allow 443   # HTTPS
ufw enable
```

### 安全审计

#### 定期安全检查
```bash
# 检查系统漏洞
apt-get update && apt-get upgrade

# 检查可疑文件
find /opt/dnc_system -name "*.py" -exec grep -l "eval\|exec\|__import__" {} \;

# 检查日志中的安全事件
grep -i "error\|fail\|denied" logs/dnc_system.log
```

---

**部署文档版本**: 1.0  
**最后更新**: 2025/10/23  
**维护团队**: DNC运维团队
