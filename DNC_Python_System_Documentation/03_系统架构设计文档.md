# DNC系统架构设计文档

## 1. 项目概述

### 1.1 系统简介
DNC（Direct Numerical Control）系统是一个数控设备参数管理软件，用于从电脑直接传送参数到NC机的宏变量系统。该系统解决了传统NC机手动输入参数的时间和错误问题。

### 1.2 系统架构 - 基于VB.NET源码分析
- **原系统**: VB.NET DNC2.05 (基于Frm_main.vb主窗体)
- **新系统**: Python重写版本 (基于VB.NET源码完整重构)
- **系统构成**: PC + NC机 + LAN线 + DNC软件 + 命名管道通信
- **数据格式**: CSV文件存储Master数据 + 动态控件系统
- **核心架构**: 8种控件系统 + 计算引擎 + 通信模块 + 数据处理

## 2. 系统功能模块

### 2.1 核心功能模块

#### 2.1.1 产品型号管理
- 产品类型定义 (type_define.csv)
- 程序类型映射 (type_prg.csv)
- 产品参数配置 (load.csv)

#### 2.1.2 参数计算引擎
- 几何参数计算 (calc.csv)
- 关系验证逻辑 (relation.csv)
- 变量定义管理 (define.csv)

#### 2.1.3 程序生成器
- 程序定义 (prg.csv)
- 控制参数 (cntrl_rex.csv)
- 选择逻辑 (select.csv)

### 2.2 数据流处理

#### 2.2.1 输入处理
```python
输入 → 参数验证 → 计算引擎 → 程序生成 → 输出
```

#### 2.2.2 宏变量映射
- #500-#600: 系统参数
- #1-#100: 用户参数
- 特殊变量: 计算中间值

## 3. 技术架构设计

### 3.1 系统架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        DNC系统架构图                            │
├─────────────────┬─────────────────┬─────────────────┬───────────┤
│   用户界面层     │   业务逻辑层     │   数据访问层     │  通信层   │
│                 │                 │                 │           │
│  - 主窗口       │  - 参数计算     │  - CSV处理器    │  - NC通信 │
│  - 输入表单     │  - 程序生成     │  - 数据验证     │  - 命名管道│
│  - 结果显示     │  - 关系验证     │  - 编码处理     │  - 协议处理│
│  - 控件管理     │  - 精度控制     │  - 缓存管理     │  - 连接管理│
└─────────────────┴─────────────────┴─────────────────┴───────────┘
         │                 │                 │             │
         ▼                 ▼                 ▼             ▼
┌─────────────────┬─────────────────┬─────────────────┬───────────┤
│   PyQt5/PySide6 │  计算表达式引擎  │   pandas处理    │  Windows  │
│   界面框架      │  关系判断引擎    │   数据缓存      │  通信API  │
└─────────────────┴─────────────────┴─────────────────┴───────────┘
```

### 3.2 核心类设计

#### 3.2.1 系统核心类架构
```python
class DNCSystem:
    """DNC系统主控制器"""
    def __init__(self):
        self.data_manager = DataManager()
        self.calculation_engine = CalculationEngine()
        self.program_generator = ProgramGenerator()
        self.ui_manager = UIManager()
        self.communication_manager = CommunicationManager()
    
    def initialize(self):
        """初始化系统"""
        self.data_manager.load_master_data()
        self.ui_manager.create_main_window()
        self.communication_manager.setup_connections()
    
    def process_request(self, product_type: str, parameters: Dict) -> str:
        """处理用户请求"""
        # 数据验证
        validated_data = self.data_manager.validate_input(parameters)
        # 参数计算
        calculated_data = self.calculation_engine.calculate(validated_data)
        # 程序生成
        program = self.program_generator.generate(calculated_data)
        return program
```

#### 3.2.2 数据管理层设计
```python
class DataManager:
    """数据管理器 - 负责所有数据操作"""
    def __init__(self):
        self.csv_processor = CSVProcessor()
        self.data_validator = DataValidator()
        self.cache_manager = CacheManager()
    
    def load_master_data(self) -> Dict[str, pd.DataFrame]:
        """加载Master数据"""
        master_files = self._scan_master_directory()
        data_tables = {}
        
        for file_path in master_files:
            table_name = self._get_table_name(file_path)
            data_tables[table_name] = self.csv_processor.load_file(file_path)
        
        return data_tables
    
    def validate_input(self, parameters: Dict) -> Dict:
        """验证输入参数"""
        return self.data_validator.validate(parameters)
```

#### 3.2.3 计算引擎层设计
```python
class CalculationEngine:
    """计算引擎 - 负责所有计算逻辑"""
    def __init__(self):
        self.expression_calculator = ExpressionCalculator()
        self.relation_judge = RelationJudge()
        self.precision_controller = PrecisionController()
    
    def calculate(self, input_data: Dict) -> Dict:
        """执行参数计算"""
        results = {}
        
        # 执行计算定义
        for calc_name, calc_expression in self._get_calculations():
            result = self.expression_calculator.calculate(calc_expression, input_data)
            results[calc_name] = self.precision_controller.round_value(result)
        
        # 验证关系条件
        for relation_name, relation_condition in self._get_relations():
            is_valid = self.relation_judge.judge(relation_condition, results)
            if not is_valid:
                raise ValidationError(f"关系验证失败: {relation_name}")
        
        return results
```

### 3.3 模块依赖关系

#### 3.3.1 核心模块依赖
```python
# 模块依赖关系定义
MODULE_DEPENDENCIES = {
    'ui_manager': ['data_manager', 'calculation_engine'],
    'data_manager': ['csv_processor', 'data_validator'],
    'calculation_engine': ['expression_calculator', 'relation_judge'],
    'program_generator': ['calculation_engine', 'template_engine'],
    'communication_manager': ['protocol_handler', 'connection_manager']
}
```

#### 3.3.2 服务容器设计
```python
class ServiceContainer:
    """服务容器 - 管理所有服务实例"""
    def __init__(self):
        self._services = {}
        self._initialize_services()
    
    def _initialize_services(self):
        """初始化所有服务"""
        # 数据服务
        self._services['csv_processor'] = CSVProcessor()
        self._services['data_validator'] = DataValidator()
        
        # 计算服务
        self._services['expression_calculator'] = ExpressionCalculator()
        self._services['relation_judge'] = RelationJudge()
        
        # 通信服务
        self._services['protocol_handler'] = NCProtocolHandler()
        self._services['connection_manager'] = ConnectionManager()
    
    def get_service(self, service_name: str):
        """获取服务实例"""
        return self._services.get(service_name)
```

## 4. 数据处理流程

### 4.1 基于VB.NET业务流程的处理流程

#### 4.1.1 完整业务处理流程
```python
class BusinessProcessHandler:
    """业务处理流程控制器"""
    def __init__(self):
        self.steps = [
            self._load_master_data,
            self._validate_input,
            self._execute_calculations,
            self._verify_relations,
            self._generate_program,
            self._send_to_nc
        ]
    
    async def process_business_request(self, request: BusinessRequest) -> BusinessResponse:
        """处理业务请求"""
        context = ProcessingContext(request)
        
        for step in self.steps:
            try:
                await step(context)
            except BusinessProcessError as e:
                logger.error(f"业务处理步骤失败: {e}")
                return BusinessResponse.error(e)
        
        return BusinessResponse.success(context.result)
    
    async def _load_master_data(self, context: ProcessingContext):
        """加载Master数据"""
        context.master_data = await self.data_manager.load_master_data()
    
    async def _validate_input(self, context: ProcessingContext):
        """验证输入参数"""
        context.validated_data = self.data_validator.validate(context.request.parameters)
    
    async def _execute_calculations(self, context: ProcessingContext):
        """执行计算"""
        context.calculated_data = self.calculation_engine.calculate(context.validated_data)
    
    async def _verify_relations(self, context: ProcessingContext):
        """验证关系条件"""
        context.verified_data = self.relation_judge.verify(context.calculated_data)
    
    async def _generate_program(self, context: ProcessingContext):
        """生成程序"""
        context.program = self.program_generator.generate(context.verified_data)
    
    async def _send_to_nc(self, context: ProcessingContext):
        """发送到NC机"""
        context.result = await self.communication_manager.send_program(context.program)
```

### 4.2 数据流架构
```
用户输入
    │
    ▼
参数验证 → 数据验证错误 → 错误处理
    │
    ▼
变量替换 → 变量未定义 → 默认值处理
    │
    ▼
计算执行 → 计算错误 → 异常处理
    │
    ▼
关系验证 → 验证失败 → 业务规则错误
    │
    ▼
程序生成 → 语法错误 → 程序验证
    │
    ▼
NC通信 → 通信失败 → 重试机制
    │
    ▼
结果反馈
```

## 5. 性能优化策略

### 5.1 大文件处理优化
- **分批读取**: 使用pandas的chunksize参数
- **内存管理**: 及时释放不需要的数据
- **缓存机制**: 缓存频繁访问的数据

### 5.2 计算优化
- **预编译**: 预编译计算表达式
- **并行处理**: 使用多线程处理独立计算
- **结果缓存**: 缓存重复计算结果

## 6. 部署和配置

### 6.1 环境要求
- Python 3.8+
- pandas >= 1.3.0
- PyQt5/PySide6
- 操作系统: Windows 10/11

### 6.2 配置文件
```ini
[system]
data_directory = ./data/master
log_level = INFO
batch_size = 1000

[encoding]
default_encoding = utf-8
fallback_encodings = shift_jis,cp932,latin1
```

---

**文档版本**: 1.0  
**最后更新**: 2025/10/23  
**维护者**: DNC开发团队
