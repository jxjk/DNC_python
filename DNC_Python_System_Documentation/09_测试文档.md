# DNC参数计算系统 - 测试文档

## 测试概述

### 测试目标
确保DNC参数计算系统的功能正确性、性能稳定性和用户体验。

### 测试范围
- 单元测试：验证单个模块的功能
- 集成测试：验证模块间的协作
- 系统测试：验证整个系统的功能
- 性能测试：验证系统的性能指标
- 用户验收测试：验证用户需求满足度

### 测试环境
- **操作系统**: Windows 10/11, Linux, macOS
- **Python版本**: 3.8+
- **测试框架**: pytest
- **测试数据**: 包含在项目中的测试数据文件

## 单元测试

### 数据管理模块测试

#### DataManager 测试
```python
import pytest
from src.data.data_manager import DataManager

class TestDataManager:
    
    def test_load_master_data(self):
        """测试加载Master数据"""
        data_manager = DataManager("data/master")
        master_data = data_manager.load_master_data()
        
        assert isinstance(master_data, dict)
        assert "type_define.csv" in master_data
        assert "load.csv" in master_data
    
    def test_batch_read_large_csv(self):
        """测试分批读取大文件"""
        data_manager = DataManager()
        result = data_manager.batch_read_large_csv("data/master/load.csv", 1000)
        
        assert not result.empty
        assert len(result) > 0
    
    def test_validate_data_integrity(self):
        """测试数据完整性验证"""
        data_manager = DataManager()
        validation_results = data_manager.validate_data_integrity()
        
        assert isinstance(validation_results, dict)
        assert all(isinstance(v, bool) for v in validation_results.values())
```

#### CSVProcessor 测试
```python
class TestCSVProcessor:
    
    def test_read_csv_with_encoding_detection(self):
        """测试带编码检测的CSV读取"""
        from src.data.csv_processor import CSVProcessor
        
        processor = CSVProcessor()
        data = processor.read_csv_with_encoding_detection("data/master/ini.csv")
        
        assert not data.empty
    
    def test_fix_encoding_issues(self):
        """测试编码问题修复"""
        from src.data.csv_processor import CSVProcessor
        
        processor = CSVProcessor()
        fixed_data = processor.fix_encoding_issues("data/master/math.csv")
        
        assert not fixed_data.empty
```

### 计算引擎测试

#### CalculationEngine 测试
```python
class TestCalculationEngine:
    
    def test_calculate_parameters(self):
        """测试参数计算"""
        from src.utils.calculation import CalculationEngine
        from src.data.data_manager import DataManager
        
        data_manager = DataManager()
        calc_engine = CalculationEngine(data_manager)
        
        input_data = {
            "Teeth_num": 20,
            "Module": 2.5,
            "Pressure_angle": 20.0
        }
        
        results = calc_engine.calculate_parameters(input_data)
        
        assert isinstance(results, dict)
        assert "calculated_values" in results
        assert "macro_variables" in results
    
    def test_validate_relations(self):
        """测试关系验证"""
        from src.utils.calculation import CalculationEngine
        from src.data.data_manager import DataManager
        
        data_manager = DataManager()
        calc_engine = CalculationEngine(data_manager)
        
        test_data = {
            "value1": 10.0,
            "value2": 5.0
        }
        
        is_valid, errors = calc_engine.validate_relations(test_data)
        
        assert isinstance(is_valid, bool)
        assert isinstance(errors, list)
```

### 配置管理测试

#### ConfigManager 测试
```python
class TestConfigManager:
    
    def test_get_set_config(self):
        """测试配置获取和设置"""
        from src.config.config_manager import ConfigManager
        
        config_manager = ConfigManager("config/config.ini")
        
        # 测试设置配置
        config_manager.set_config("TEST", "test_key", "test_value")
        
        # 测试获取配置
        value = config_manager.get_config("TEST", "test_key")
        
        assert value == "test_value"
    
    def test_save_config(self):
        """测试配置保存"""
        from src.config.config_manager import ConfigManager
        
        config_manager = ConfigManager("config/config.ini")
        
        # 修改配置
        config_manager.set_config("TEST", "save_test", "saved_value")
        
        # 保存配置
        config_manager.save_config()
        
        # 重新加载验证
        new_config_manager = ConfigManager("config/config.ini")
        value = new_config_manager.get_config("TEST", "save_test")
        
        assert value == "saved_value"
```

## 集成测试

### 数据流集成测试
```python
class TestDataFlowIntegration:
    
    def test_complete_data_processing_flow(self):
        """测试完整的数据处理流程"""
        from src.data.data_manager import DataManager
        from src.utils.calculation import CalculationEngine
        from src.data.models import ProductType
        
        # 初始化组件
        data_manager = DataManager()
        calc_engine = CalculationEngine(data_manager)
        
        # 加载数据
        master_data = data_manager.load_master_data()
        
        # 验证数据完整性
        validation_results = data_manager.validate_data_integrity()
        
        # 执行计算
        input_params = {
            "Teeth_num": 25,
            "Module": 3.0,
            "Pressure_angle": 20.0
        }
        
        results = calc_engine.calculate_parameters(input_params)
        
        # 验证结果
        assert results is not None
        assert "calculated_values" in results
        assert "macro_variables" in results
        assert len(results["macro_variables"]) > 0
```

### 程序生成集成测试
```python
class TestProgramGenerationIntegration:
    
    def test_program_generation_flow(self):
        """测试程序生成流程"""
        from src.data.data_manager import DataManager
        from src.utils.calculation import CalculationEngine
        from src.ui.main_window import ProgramGenerator
        
        # 初始化组件
        data_manager = DataManager()
        calc_engine = CalculationEngine(data_manager)
        program_generator = ProgramGenerator(data_manager)
        
        # 计算参数
        input_params = {
            "Teeth_num": 30,
            "Module": 2.5,
            "Pressure_angle": 20.0
        }
        
        calculated_params = calc_engine.calculate_parameters(input_params)
        
        # 生成程序
        program_code = program_generator.generate_nc_program(
            "GPA18GT15040-A", 
            calculated_params
        )
        
        # 验证程序
        assert program_code is not None
        assert len(program_code) > 0
        assert "O0001" in program_code  # 程序头
```

## 系统测试

### 功能测试用例

#### 测试用例1: 基本参数计算
```python
def test_basic_parameter_calculation():
    """测试基本参数计算功能"""
    # 测试步骤
    # 1. 启动系统
    # 2. 选择产品类型 GPA18GT15040-A
    # 3. 输入基本参数: 齿数=20, 模数=2.5
    # 4. 执行计算
    # 5. 验证计算结果
    
    expected_results = {
        "outer_diameter": 52.5,
        "root_diameter": 47.5,
        "base_diameter": 46.98
    }
    
    # 执行测试并验证
    actual_results = execute_calculation_test("GPA18GT15040-A", 20, 2.5)
    
    for key, expected_value in expected_results.items():
        assert abs(actual_results[key] - expected_value) < 0.01
```

#### 测试用例2: 程序生成功能
```python
def test_program_generation():
    """测试程序生成功能"""
    # 测试步骤
    # 1. 计算参数
    # 2. 选择程序类型 prg1
    # 3. 生成程序
    # 4. 验证程序语法
    # 5. 验证程序内容
    
    program_code = generate_program_test("GPA18GT15040-A", "prg1")
    
    # 验证程序头
    assert program_code.startswith("O0001")
    
    # 验证程序尾
    assert program_code.strip().endswith("M30")
    
    # 验证包含必要的G代码
    assert "G00" in program_code
    assert "G01" in program_code
```

#### 测试用例3: 数据导出功能
```python
def test_data_export():
    """测试数据导出功能"""
    # 测试步骤
    # 1. 计算参数
    # 2. 导出为CSV格式
    # 3. 验证导出文件
    # 4. 验证数据完整性
    
    export_file = export_data_test("test_export.csv")
    
    # 验证文件存在
    assert os.path.exists(export_file)
    
    # 验证文件内容
    with open(export_file, 'r', encoding='utf-8') as f:
        content = f.read()
        assert "Teeth_num" in content
        assert "Module" in content
        assert "20" in content  # 测试数据
```

### 边界测试用例

#### 测试用例4: 边界值测试
```python
def test_boundary_values():
    """测试边界值情况"""
    test_cases = [
        {"Teeth_num": 1, "Module": 0.5},   # 最小齿数
        {"Teeth_num": 200, "Module": 10.0}, # 最大齿数
        {"Teeth_num": 0, "Module": 2.5},    # 无效齿数
        {"Teeth_num": 20, "Module": 0},     # 无效模数
    ]
    
    for i, test_case in enumerate(test_cases):
        try:
            results = execute_calculation_test(
                "GPA18GT15040-A", 
                test_case["Teeth_num"], 
                test_case["Module"]
            )
            
            # 对于有效测试用例，验证结果
            if i < 2:  # 前两个是有效测试用例
                assert results is not None
            else:  # 后两个是无效测试用例
                assert False, "应该抛出异常"
                
        except ValueError as e:
            # 对于无效测试用例，期望抛出异常
            if i >= 2:
                assert "无效" in str(e) or "错误" in str(e)
```

## 性能测试

### 数据加载性能测试
```python
class TestPerformance:
    
    def test_data_loading_performance(self):
        """测试数据加载性能"""
        import time
        
        data_manager = DataManager()
        
        start_time = time.time()
        master_data = data_manager.load_master_data()
        load_time = time.time() - start_time
        
        # 性能要求：加载时间 < 5秒
        assert load_time < 5.0, f"数据加载时间过长: {load_time:.2f}秒"
        
        print(f"数据加载时间: {load_time:.2f}秒")
    
    def test_calculation_performance(self):
        """测试计算性能"""
        import time
        
        data_manager = DataManager()
        calc_engine = CalculationEngine(data_manager)
        
        # 测试批量计算性能
        test_cases = [
            {"Teeth_num": 20, "Module": 2.5},
            {"Teeth_num": 30, "Module": 3.0},
            {"Teeth_num": 40, "Module": 2.0},
            {"Teeth_num": 50, "Module": 2.5},
        ]
        
        start_time = time.time()
        
        for test_case in test_cases:
            results = calc_engine.calculate_parameters(test_case)
            assert results is not None
        
        total_time = time.time() - start_time
        
        # 性能要求：平均计算时间 < 0.5秒
        avg_time = total_time / len(test_cases)
        assert avg_time < 0.5, f"平均计算时间过长: {avg_time:.2f}秒"
        
        print(f"平均计算时间: {avg_time:.2f}秒")
```

### 内存使用测试
```python
def test_memory_usage():
    """测试内存使用情况"""
    import psutil
    import os
    
    process = psutil.Process(os.getpid())
    
    # 记录初始内存
    initial_memory = process.memory_info().rss / 1024 / 1024  # MB
    
    # 执行内存密集型操作
    data_manager = DataManager()
    master_data = data_manager.load_master_data()
    
    # 记录峰值内存
    peak_memory = process.memory_info().rss / 1024 / 1024  # MB
    
    memory_increase = peak_memory - initial_memory
    
    # 内存要求：内存增加 < 500MB
    assert memory_increase < 500, f"内存使用过多: {memory_increase:.2f}MB"
    
    print(f"内存增加: {memory_increase:.2f}MB")
```

## 用户界面测试

### 界面响应测试
```python
class TestUIResponsiveness:
    
    def test_ui_loading_time(self):
        """测试界面加载时间"""
        import time
        
        start_time = time.time()
        
        # 模拟界面加载
        main_window = MainWindow()
        main_window.show()
        
        load_time = time.time() - start_time
        
        # 性能要求：界面加载时间 < 3秒
        assert load_time < 3.0, f"界面加载时间过长: {load_time:.2f}秒"
        
        print(f"界面加载时间: {load_time:.2f}秒")
    
    def test_ui_interaction_responsiveness(self):
        """测试界面交互响应性"""
        import time
        
        main_window = MainWindow()
        
        # 测试按钮点击响应
        start_time = time.time()
        main_window.calculate_button.click()
        response_time = time.time() - start_time
        
        # 性能要求：响应时间 < 0.1秒
        assert response_time < 0.1, f"界面响应时间过长: {response_time:.2f}秒"
        
        print(f"界面响应时间: {response_time:.2f}秒")
```

## 测试数据

### 测试数据文件
测试数据位于 `tests/test_data/` 目录：

- `test_type_define.csv` - 测试产品类型定义
- `test_load.csv` - 测试主数据
- `test_calc.csv` - 测试计算定义
- `test_relation.csv` - 测试关系验证

### 测试数据生成
```python
def generate_test_data():
    """生成测试数据"""
    test_data = {
        "type_define.csv": [
            ["NO", "TYPE", "DEFINE1", "DEFINE2"],
            [1, "TEST001", "测试类型1", "测试定义1"],
            [2, "TEST002", "测试类型2", "测试定义2"]
        ],
        "load.csv": [
            ["NO", "TYPE", "DRAWING", "DISPFLG", "#1", "#2"],
            [1, "TEST001", "TEST001.dwg", "1", "20", "2.5"],
            [2, "TEST002", "TEST002.dwg", "1", "30", "3.0"]
        ]
    }
    
    for filename, data in test_data.items():
        filepath = f"tests/test_data/{filename}"
        with open(filepath, 'w', newline='', encoding='utf-8') as f:
            writer = csv.writer(f)
            writer.writerows(data)
```

## 测试报告

### 测试执行
```bash
# 运行所有测试
pytest tests/ -v

# 运行特定测试类别
pytest tests/unit/ -v
pytest tests/integration/ -v
pytest tests/performance/ -v

# 生成测试报告
pytest tests/ --html=reports/test_report.html
```

### 测试覆盖率
```bash
# 生成测试覆盖率报告
pytest tests/ --cov=src --cov-report=html
```

### 测试结果分析
测试结果将生成以下报告：
- `reports/test_report.html` - 测试执行报告
- `reports/coverage/` - 代码覆盖率报告
- `reports/performance/` - 性能测试报告

## 持续集成

### GitHub Actions 配置
```yaml
name: DNC System Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: [3.8, 3.9, 3.10]
    
    steps:
    - uses: actions/checkout@v2
    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt
    
    - name: Run tests
      run: |
        pytest tests/ -v --cov=src --cov-report=xml
    
    - name: Upload coverage
      uses: codecov/codecov-action@v2
```

---

**测试文档版本**: 1.0  
**最后更新**: 2025/10/23  
**测试负责人**: DNC测试团队
