# DNC系统架构设计文档

## 1. 系统概述

### 1.1 项目背景
DNC（Direct Numerical Control）系统是一个数控设备参数管理软件，用于从电脑直接传送参数到NC机的宏变量系统。该系统解决了传统NC机手动输入参数的时间和错误问题。

### 1.2 系统目标
- 实现产品型号的自动识别和处理
- 提供灵活的程序显示和切换机制
- 支持复杂的参数计算和验证
- 提高NC机参数设置的效率和准确性

### 1.3 核心价值
- **效率提升**: 自动化参数计算和传输
- **准确性**: 减少人为输入错误
- **灵活性**: 支持多种产品型号和配置
- **可维护性**: 基于配置文件的系统架构

## 2. 系统架构

### 2.1 整体架构图

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   用户界面层     │    │   业务逻辑层     │    │   数据访问层     │
│                 │    │                 │    │                 │
│  - 主窗口       │◄──►│  - 型号识别     │◄──►│  - CSV处理器    │
│  - 程序显示     │    │  - 程序匹配     │    │  - 数据验证     │
│  - 参数输入     │    │  - 计算引擎     │    │  - 编码处理     │
│  - 控件管理     │    │  - 关系验证     │    │  - 文件管理     │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                        │                        │
         ▼                        ▼                        ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   通信层        │    │   配置层        │    │   工具层        │
│                 │    │                 │    │                 │
│  - NC通信       │    │  - 配置管理     │    │  - 日志系统     │
│  - 命名管道     │    │  - 参数设置     │    │  - 错误处理     │
│  - 协议支持     │    │  - 系统设置     │    │  - 工具函数     │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 2.2 架构层次说明

#### 2.2.1 用户界面层
- **职责**: 提供用户交互界面，显示数据和接收输入
- **组件**: 主窗口、控件系统、程序显示、参数输入
- **技术**: PyQt5/PySide6 GUI框架

#### 2.2.2 业务逻辑层
- **职责**: 处理核心业务逻辑，执行计算和验证
- **组件**: 型号识别、程序匹配、计算引擎、关系验证
- **技术**: Python业务逻辑、算法实现

#### 2.2.3 数据访问层
- **职责**: 管理数据文件访问和处理
- **组件**: CSV处理器、数据验证、文件管理
- **技术**: pandas数据处理、文件I/O

#### 2.2.4 通信层
- **职责**: 处理与外部设备的通信
- **组件**: NC通信、命名管道、协议支持
- **技术**: 串口通信、网络通信、命名管道

#### 2.2.5 配置层
- **职责**: 管理系统配置和参数设置
- **组件**: 配置管理、参数设置、系统设置
- **技术**: configparser、JSON配置

#### 2.2.6 工具层
- **职责**: 提供系统工具和辅助功能
- **组件**: 日志系统、错误处理、工具函数
- **技术**: logging模块、异常处理

## 3. 功能模块设计

### 3.1 型号识别模块

#### 3.1.1 QR码识别模式
- **Qrmode=0**: 固定字符删除模式
- **Qrmode=1**: 分隔符分割模式
- **支持格式**: PO@型号@数量

#### 3.1.2 型号分割处理
- **分割规则**: 使用"-"字符分割型号字符串
- **前缀处理**: 基于header.csv删除指定前缀
- **内部定义**: 自动识别size1、size2等关键参数

### 3.2 程序显示模块

#### 3.2.1 型号匹配算法
- **反向字符删除匹配**: 从完整型号向后逐个删除字符匹配
- **文件参照**: type_define.csv、type_relation.csv、type_chngvl.csv

#### 3.2.2 程序顺序定义
- **程序映射**: type_prg.csv定义程序显示顺序
- **程序信息**: prg.csv存储程序详细信息

### 3.3 参数计算模块

#### 3.3.1 多层计算逻辑
- **变量定义**: define.csv定义变量转换规则
- **值转换**: chngValue.csv处理值映射
- **计算逻辑**: calc.csv定义计算表达式

#### 3.3.2 控件类型支持
- **8种核心控件**: load、input、measure、select、relation、switch、correct、add
- **动态控件管理**: 基于cntrl.csv配置动态创建

### 3.4 通信模块

#### 3.4.1 NC机床通信
- **协议支持**: Rexroth、Brother等NC协议
- **消息格式化**: 生成G代码和宏变量设置

#### 3.4.2 进程间通信
- **命名管道**: 支持异步数据接收
- **连接管理**: 实时监控连接状态

## 4. 数据流设计

### 4.1 主要数据流

#### 4.1.1 型号识别数据流
```
QR码输入 → 型号分割 → 前缀处理 → 内部定义 → 型号匹配 → 程序确定
```

#### 4.1.2 参数计算数据流
```
程序确定 → 加载参数 → 变量替换 → 值转换 → 计算执行 → 结果显示
```

#### 4.1.3 用户交互数据流
```
用户输入 → 事件处理 → 数据验证 → 计算更新 → 界面刷新
```

### 4.2 文件数据流

#### 4.2.1 配置文件加载
```
ini.csv → 系统配置
header.csv → 前缀处理规则
type_define.csv → 型号定义
type_prg.csv → 程序映射
prg.csv → 程序信息
```

#### 4.2.2 参数文件加载
```
load.csv → 程序参数
cntrl.csv → 控件定义
define.csv → 变量定义
chngValue.csv → 值转换
calc.csv → 计算逻辑
relation.csv → 关系验证
```

## 5. 技术架构

### 5.1 技术栈选择

#### 5.1.1 开发语言
- **Python 3.8+**: 主要开发语言
- **优势**: 丰富的库支持、跨平台兼容、开发效率高

#### 5.1.2 界面框架
- **PyQt5/PySide6**: 功能丰富的GUI框架
- **优势**: 跨平台、功能强大、社区活跃

#### 5.1.3 数据处理
- **pandas**: 表格数据处理
- **优势**: 高性能、功能丰富、易于使用

#### 5.1.4 配置管理
- **configparser**: INI文件处理
- **优势**: 标准库、简单易用

### 5.2 设计模式应用

#### 5.2.1 工厂模式
- **应用场景**: 控件创建
- **实现方式**: ControlFactory类根据配置创建不同类型控件

#### 5.2.2 观察者模式
- **应用场景**: 事件处理
- **实现方式**: EventDispatcher管理事件订阅和分发

#### 5.2.3 策略模式
- **应用场景**: 计算算法
- **实现方式**: 不同的计算策略实现统一接口

#### 5.2.4 单例模式
- **应用场景**: 配置管理、日志系统
- **实现方式**: 确保全局唯一实例

## 6. 性能设计

### 6.1 数据访问优化

#### 6.1.1 缓存策略
- **数据表缓存**: 频繁访问的数据表缓存到内存
- **计算结果缓存**: 重复计算的结果缓存
- **界面状态缓存**: 界面控件的状态缓存

#### 6.1.2 懒加载
- **按需数据加载**: 只在需要时加载数据文件
- **延迟计算**: 用户交互时才执行计算
- **动态控件创建**: 按需创建界面控件

### 6.2 计算优化

#### 6.2.1 表达式优化
- **表达式预编译**: 预编译常用计算表达式
- **变量替换优化**: 优化变量替换算法
- **函数调用优化**: 减少不必要的函数调用

#### 6.2.2 并行计算
- **多线程计算**: 复杂计算使用多线程
- **批量处理**: 支持批量数据处理
- **异步计算**: 非阻塞的计算执行

## 7. 可扩展性设计

### 7.1 插件架构

#### 7.1.1 计算算法扩展
- **接口定义**: 统一的计算算法接口
- **插件加载**: 动态加载计算插件
- **配置驱动**: 通过配置文件启用插件

#### 7.1.2 文件格式扩展
- **格式适配器**: 统一的文件格式接口
- **插件机制**: 支持新的文件格式插件
- **自动检测**: 自动识别文件格式

#### 7.1.3 第三方集成
- **API接口**: 提供标准化的API接口
- **Web服务**: 支持RESTful API
- **数据交换**: 标准化的数据交换格式

### 7.2 配置驱动

#### 7.2.1 运行时配置
- **热重载**: 支持配置文件的运行时更新
- **环境配置**: 不同环境的配置管理
- **用户设置**: 用户自定义配置保存

#### 7.2.2 业务规则配置
- **规则引擎**: 可配置的业务规则
- **验证规则**: 动态的验证规则配置
- **计算规则**: 灵活的计算规则定义

## 8. 安全设计

### 8.1 数据安全

#### 8.1.1 输入验证
- **数据格式验证**: 验证输入数据的格式
- **数值范围检查**: 检查数值在合理范围内
- **业务规则验证**: 基于业务规则的验证

#### 8.1.2 文件权限
- **访问控制**: 控制文件的读写权限
- **备份机制**: 重要数据的自动备份
- **恢复机制**: 数据损坏时的恢复机制

### 8.2 系统安全

#### 8.2.1 异常处理
- **全面异常捕获**: 捕获所有可能的异常
- **优雅降级**: 异常情况下的系统降级
- **错误恢复**: 自动错误恢复机制

#### 8.2.2 资源管理
- **内存管理**: 合理的内存使用和释放
- **文件句柄**: 及时释放文件资源
- **连接管理**: 通信连接的合理管理

## 9. 部署架构

### 9.1 部署模式

#### 9.1.1 单机部署
- **适用场景**: 小型车间、单台NC机
- **部署方式**: 直接安装到工控机
- **优势**: 简单、稳定、成本低

#### 9.1.2 网络部署
- **适用场景**: 多台NC机、集中管理
- **部署方式**: 服务器+客户端模式
- **优势**: 集中管理、数据共享

### 9.2 系统要求

#### 9.2.1 硬件要求
- **CPU**: Intel i3或同等性能
- **内存**: 4GB RAM（推荐8GB）
- **存储**: 500MB可用空间
- **网络**: 100Mbps以太网

#### 9.2.2 软件要求
- **操作系统**: Windows 10/11, Linux, macOS
- **Python**: 3.8或更高版本
- **依赖库**: 见requirements.txt

## 10. 监控和维护

### 10.1 系统监控

#### 10.1.1 性能监控
- **CPU使用率**: 监控系统CPU使用情况
- **内存使用**: 监控内存使用情况
- **磁盘空间**: 监控磁盘空间使用

#### 10.1.2 业务监控
- **处理数量**: 监控处理的型号数量
- **计算时间**: 监控计算执行时间
- **错误率**: 监控系统错误率

### 10.2 维护策略

#### 10.2.1 日常维护
- **日志检查**: 定期检查系统日志
- **数据备份**: 定期备份重要数据
- **配置更新**: 及时更新配置文件

#### 10.2.2 故障处理
- **问题诊断**: 系统化的故障诊断流程
- **恢复流程**: 标准化的系统恢复流程
- **用户支持**: 完善的用户支持体系

---

**文档版本**: v1.0  
**最后更新**: 2025年10月24日  
**维护者**: DNC开发团队
