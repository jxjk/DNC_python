# DNC系统部署和维护指南

## 1. 部署规划

### 1.1 部署环境评估

#### 1.1.1 硬件环境评估
- **生产环境硬件要求**:
  - 处理器: Intel i5或同等性能以上
  - 内存: 8GB RAM（推荐16GB）
  - 存储: 1GB可用空间
  - 网络: 千兆以太网
  - 外设: USB接口QR码扫描器

- **网络环境要求**:
  - 局域网连接稳定性
  - NC设备网络可达性
  - 防火墙端口配置

#### 1.1.2 软件环境评估
- **操作系统兼容性**:
  - Windows 10/11（推荐）
  - Linux（Ubuntu 18.04+，CentOS 7+）
  - macOS（10.15+）

- **依赖软件**:
  - Python 3.8+
  - 必要的Python包
  - 数据库（如需要）

### 1.2 部署策略

#### 1.2.1 单机部署
- **适用场景**: 单个工作站使用
- **部署方式**: 直接安装包安装
- **配置要求**: 本地配置文件

#### 1.2.2 网络部署
- **适用场景**: 多工作站共享
- **部署方式**: 客户端-服务器架构
- **配置要求**: 网络配置、数据同步

#### 1.2.3 集群部署
- **适用场景**: 高可用性要求
- **部署方式**: 负载均衡配置
- **配置要求**: 集群管理、数据一致性

## 2. 部署流程

### 2.1 单机部署步骤

#### 2.1.1 环境准备
1. **系统检查**:
   ```bash
   # 检查Python版本
   python --version
   
   # 检查系统架构
   systeminfo | findstr /C:"System Type"
   ```

2. **依赖安装**:
   ```bash
   # 安装必要的Python包
   pip install -r requirements.txt
   
   # 安装系统依赖（Windows）
   # 可能需要安装Visual C++ Redistributable
   ```

#### 2.1.2 软件安装
1. **安装包部署**:
   ```bash
   # 运行安装程序
   DNC_Setup.exe /SILENT
   
   # 或手动安装
   python setup.py install
   ```

2. **配置文件部署**:
   ```bash
   # 复制配置文件
   copy config\*.csv "C:\Program Files\DNC System\config\"
   
   # 验证配置
   python -c "from src.config import Config; Config.validate()"
   ```

#### 2.1.3 系统配置
1. **基本配置**:
   ```ini
   [System]
   Language=zh-CN
   Theme=default
   AutoStart=true
   
   [Network]
   NCProtocol=rexroth
   Timeout=30
   RetryCount=3
   ```

2. **设备配置**:
   ```ini
   [QRScanner]
   Port=COM3
   BaudRate=9600
   DataBits=8
   StopBits=1
   Parity=None
   
   [NCDevice]
   IP=192.168.1.100
   Port=502
   Protocol=rexroth
   ```

### 2.2 网络部署步骤

#### 2.2.1 服务器端部署
1. **服务器环境准备**:
   ```bash
   # 安装Web服务器（可选）
   # 配置数据库（如需要）
   # 设置共享文件夹
   ```

2. **服务部署**:
   ```bash
   # 部署DNC服务
   sc create DNCService binPath="C:\Program Files\DNC System\dnc_service.exe"
   sc start DNCService
   ```

#### 2.2.2 客户端部署
1. **客户端安装**:
   ```bash
   # 安装客户端软件
   DNC_Client_Setup.exe /SILENT
   ```

2. **网络配置**:
   ```ini
   [Server]
   Host=dnc-server.company.com
   Port=8080
   UseSSL=true
   
   [Sync]
   AutoSync=true
   SyncInterval=300
   ```

### 2.3 部署验证

#### 2.3.1 功能验证
1. **基本功能测试**:
   ```python
   # 测试型号识别
   python -c "from src.model_recognizer import ModelRecognizer; print('型号识别测试通过')"
   
   # 测试参数计算
   python -c "from src.calculation_engine import CalculationEngine; print('参数计算测试通过')"
   ```

2. **集成测试**:
   ```bash
   # 运行部署验证脚本
   python deployment_test.py
   ```

#### 2.3.2 性能验证
1. **响应时间测试**:
   ```bash
   # 测试系统启动时间
   measure-command { Start-Process "DNC System" -Wait }
   
   # 测试型号识别性能
   python performance_test.py --test model_recognition
   ```

2. **稳定性测试**:
   ```bash
   # 长时间运行测试
   python stability_test.py --duration 24h
   ```

## 3. 系统配置

### 3.1 配置文件说明

#### 3.1.1 主要配置文件
- **ini.csv**: 系统主配置文件
- **header.csv**: 型号前缀处理配置
- **type_define.csv**: 型号定义配置
- **type_prg.csv**: 程序映射配置
- **prg.csv**: 程序信息配置

#### 3.1.2 参数配置文件
- **load.csv**: 程序参数配置
- **cntrl.csv**: 控件定义配置
- **define.csv**: 变量定义配置
- **chngValue.csv**: 值转换配置
- **calc.csv**: 计算逻辑配置
- **relation.csv**: 关系验证配置

### 3.2 配置管理

#### 3.2.1 配置备份
```bash
# 自动备份配置
python backup_config.py --destination "D:\Backup\DNC_Config"

# 恢复配置
python restore_config.py --source "D:\Backup\DNC_Config\20251024"
```

#### 3.2.2 配置版本控制
```bash
# 使用Git管理配置变更
git init
git add config/
git commit -m "初始配置"
```

### 3.3 环境配置

#### 3.3.1 开发环境配置
```python
# development.ini
[Environment]
Mode=development
Debug=true
LogLevel=DEBUG

[Database]
Type=sqlite
Path=./data/development.db
```

#### 3.3.2 生产环境配置
```python
# production.ini
[Environment]
Mode=production
Debug=false
LogLevel=INFO

[Database]
Type=postgresql
Host=db-server
Port=5432
Name=dnc_production
```

## 4. 系统维护

### 4.1 日常维护

#### 4.1.1 日志管理
1. **日志文件清理**:
   ```bash
   # 自动清理旧日志
   python log_cleanup.py --keep-days 30 --max-size 100MB
   ```

2. **日志分析**:
   ```bash
   # 分析错误日志
   python log_analyzer.py --level ERROR --period 7d
   ```

#### 4.1.2 数据备份
1. **自动备份**:
   ```bash
   # 配置定时备份任务
   schtasks /create /tn "DNC Backup" /tr "python backup_data.py" /sc daily /st 02:00
   ```

2. **备份验证**:
   ```bash
   # 验证备份完整性
   python verify_backup.py --backup-file "backup_20251024.zip"
   ```

#### 4.1.3 性能监控
1. **系统资源监控**:
   ```bash
   # 监控CPU和内存使用
   python monitor_resources.py --interval 60 --output metrics.csv
   ```

2. **应用性能监控**:
   ```bash
   # 监控应用性能指标
   python monitor_performance.py --metrics response_time,throughput,error_rate
   ```

### 4.2 定期维护

#### 4.2.1 月度维护
1. **系统更新检查**:
   ```bash
   # 检查Python包更新
   pip list --outdated
   
   # 检查系统补丁
   wmic qfe list brief
   ```

2. **数据库维护**:
   ```bash
   # 数据库优化
   python optimize_database.py --vacuum --reindex
   ```

#### 4.2.2 季度维护
1. **安全审计**:
   ```bash
   # 安全漏洞扫描
   python security_scan.py --check-dependencies --check-config
   ```

2. **性能调优**:
   ```bash
   # 性能分析
   python profile_performance.py --duration 1h
   ```

### 4.3 故障处理

#### 4.3.1 常见故障诊断

**问题1: 型号识别失败**
```bash
# 诊断步骤
1. 检查QR码扫描器连接
2. 验证配置文件格式
3. 检查型号定义文件
4. 查看错误日志

# 修复命令
python diagnose_model_recognition.py --qr-code "TEST@MODEL@100"
```

**问题2: 参数计算错误**
```bash
# 诊断步骤
1. 检查计算规则文件
2. 验证型号分割结果
3. 检查变量定义
4. 查看计算日志

# 修复命令
python diagnose_calculation.py --model "C-CCC10-20A-P5-30" --program 1
```

**问题3: NC通信失败**
```bash
# 诊断步骤
1. 检查网络连接
2. 验证NC设备状态
3. 检查通信协议配置
4. 查看通信日志

# 修复命令
python diagnose_nc_communication.py --device 192.168.1.100 --port 502
```

#### 4.3.2 故障恢复流程

1. **识别故障**:
   ```bash
   # 检查系统状态
   python check_system_status.py --all
   ```

2. **隔离问题**:
   ```bash
   # 确定故障模块
   python isolate_issue.py --logs "C:\Logs\dnc.log"
   ```

3. **执行修复**:
   ```bash
   # 根据诊断结果执行修复
   python apply_fix.py --issue "model_recognition" --fix "update_config"
   ```

4. **验证修复**:
   ```bash
   # 验证修复效果
   python verify_fix.py --test-scenario "full_workflow"
   ```

## 5. 升级和迁移

### 5.1 版本升级

#### 5.1.1 小版本升级
1. **备份当前版本**:
   ```bash
   # 备份配置和数据
   python backup_system.py --include config,data,logs
   ```

2. **安装新版本**:
   ```bash
   # 停止当前服务
   net stop DNCService
   
   # 安装新版本
   DNC_Setup_v1.1.exe /SILENT
   
   # 启动服务
   net start DNCService
   ```

3. **验证升级**:
   ```bash
   # 验证新版本功能
   python upgrade_verification.py --version 1.1
   ```

#### 5.1.2 大版本升级
1. **兼容性检查**:
   ```bash
   # 检查配置兼容性
   python check_compatibility.py --target-version 2.0
   ```

2. **数据迁移**:
   ```bash
   # 迁移数据到新版本
   python migrate_data.py --source-version 1.0 --target-version 2.0
   ```

3. **回滚准备**:
   ```bash
   # 准备回滚方案
   python prepare_rollback.py --backup-file "backup_v1.0.zip"
   ```

### 5.2 系统迁移

#### 5.2.1 硬件迁移
1. **新环境准备**:
   ```bash
   # 在新硬件上安装系统
   DNC_Setup.exe /SILENT
   ```

2. **数据迁移**:
   ```bash
   # 迁移配置和数据
   python migrate_to_new_hardware.py --source "old_pc" --destination "new_pc"
   ```

3. **验证迁移**:
   ```bash
   # 验证迁移结果
   python verify_migration.py --compare old_pc new_pc
   ```

#### 5.2.2 平台迁移
1. **跨平台兼容性检查**:
   ```bash
   # 检查Windows到Linux迁移
   python check_cross_platform.py --source windows --target linux
   ```

2. **平台特定配置**:
   ```bash
   # 调整平台特定配置
   python adjust_platform_config.py --target linux
   ```

## 6. 监控和告警

### 6.1 系统监控

#### 6.1.1 资源监控
```bash
# 监控系统资源使用
python monitor_system.py --metrics cpu,memory,disk,network --interval 30
```

#### 6.1.2 应用监控
```bash
# 监控应用性能
python monitor_application.py --metrics response_time,error_rate,throughput
```

### 6.2 告警配置

#### 6.2.1 阈值设置
```python
# alert_config.ini
[CPU]
Warning=80
Critical=95

[Memory]
Warning=85
Critical=95

[Disk]
Warning=90
Critical=98

[Application]
ErrorRateWarning=1
ErrorRateCritical=5
ResponseTimeWarning=1000
ResponseTimeCritical=5000
```

#### 6.2.2 告警通知
```bash
# 配置邮件告警
python configure_alerts.py --email "admin@company.com" --level critical
```

## 7. 安全维护

### 7.1 安全配置

#### 7.1.1 访问控制
```python
# security.ini
[Authentication]
RequireLogin=true
SessionTimeout=3600
MaxLoginAttempts=3

[Authorization]
AdminUsers=user1,user2
ReadOnlyUsers=user3,user4
```

#### 7.1.2 数据加密
```bash
# 配置数据加密
python configure_encryption.py --algorithm AES256 --key-file "encryption.key"
```

### 7.2 安全审计

#### 7.2.1 日志审计
```bash
# 审计安全相关日志
python audit_security_logs.py --period 30d --output security_report.html
```

#### 7.2.2 漏洞扫描
```bash
# 定期安全扫描
python security_scan.py --check-dependencies --check-config --report vulnerabilities.json
```

## 8. 文档和培训

### 8.1 操作文档

#### 8.1.1 维护手册
- 日常维护流程
- 故障处理指南
- 备份和恢复流程

#### 8.1.2 配置文档
- 配置文件说明
- 环境配置指南
- 性能调优指南

### 8.2 培训材料

#### 8.2.1 管理员培训
- 系统架构理解
- 维护操作培训
- 故障诊断培训

#### 8.2.2 用户培训
- 基本操作培训
- 故障报告流程
- 最佳实践分享

---

**文档版本**: v1.0  
**最后更新**: 2025年10月24日  
**维护团队**: DNC系统运维团队  
**支持联系方式**: support@dnc-system.com
