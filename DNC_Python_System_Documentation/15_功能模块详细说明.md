# 功能模块详细说明

## 概述

本文档基于VB.NET源码分析结果，详细说明DNC系统的各个功能模块，为Python重构提供完整的功能规格说明。

## 1. 控件系统模块

### 1.1 控件类型说明

#### Load控件 (makeCntrlLoad)
**功能**：数据加载控件，用于从数据源加载和显示数据
**特性**：
- 支持从CSV文件加载数据
- 支持数据验证和格式化
- 自动更新相关控件值
**Python实现建议**：
```python
class LoadControl:
    def __init__(self, data_source, field_mapping):
        self.data_source = data_source
        self.field_mapping = field_mapping
    
    def load_data(self):
        # 实现数据加载逻辑
        pass
    
    def validate_data(self):
        # 实现数据验证
        pass
```

#### Input控件 (makeCntrlInput)
**功能**：用户输入控件，支持多种输入方式
**特性**：
- 支持键盘输入和计算器输入
- 数据格式验证
- 输入值范围限制
**事件处理**：
- 文本变更事件
- 按钮点击事件
- 焦点变更事件

#### Measure控件 (makeCntrlMeasure)
**功能**：测量数据输入和显示控件
**特性**：
- 支持测量单位转换
- 数据精度控制
- 背景色提示（正常/警告/错误）
**特殊处理**：
- 测量值自动计算
- 公差范围检查
- 测量结果格式化

#### Select控件 (makeCntrlSelect)
**功能**：选择列表控件，提供预定义选项
**特性**：
- 下拉列表选择
- 选项动态加载
- 选择值验证
**数据源**：
- 从CSV文件加载选项
- 支持条件过滤
- 选项排序

#### Relation控件 (makeCntrlRelation)
**功能**：关系数据控件，处理数据间关联
**特性**：
- 多表关联查询
- 条件判断逻辑
- 动态值更新
**关系逻辑**：
- 一对一关系
- 一对多关系
- 条件关系

#### Switch控件 (makeCntrlSwitch)
**功能**：状态切换控件，支持多状态循环
**特性**：
- 状态循环切换
- 状态值映射
- 状态变更事件
**状态管理**：
- 状态顺序定义
- 状态值转换
- 状态持久化

#### Correct控件 (makeCntrlCorrect)
**功能**：数据校正控件，支持数值调整
**特性**：
- 数值微调功能
- 校正范围限制
- 校正历史记录
**校正方式**：
- 加减校正
- 比例校正
- 公式校正

#### Add控件 (makeCntrlAdd)
**功能**：动态添加控件组
**特性**：
- 控件组动态创建
- 组内数据关联
- 组管理功能
**组管理**：
- 组添加/删除
- 组数据验证
- 组间关系处理

### 1.2 控件布局系统

#### 表格布局 (makeTLP)
**功能**：基于表格的控件布局管理
**特性**：
- 行列自动排列
- 控件间距控制
- 响应式布局调整
**布局规则**：
- 固定行列数
- 动态行列调整
- 控件对齐方式

#### 流式布局 (FlowLayoutPanel)
**功能**：流式控件排列
**特性**：
- 自动换行排列
- 控件大小自适应
- 布局动态调整

## 2. 计算引擎模块

### 2.1 表达式计算 (getCalcResult)

**功能**：数学表达式计算和求值
**支持的运算符**：
- 算术运算符：+、-、*、/、^
- 比较运算符：=、<>、<、>、<=、>=
- 逻辑运算符：AND、OR、NOT

**变量支持**：
```python
# 表达式示例
"@A + @B * 2"  # 支持变量替换
"MAX(@X, @Y)"  # 支持函数调用
```

**错误处理**：
- 语法错误检测
- 除零错误处理
- 变量未定义处理

### 2.2 数学函数库 (chkMath)

**内置函数**：
- 三角函数：SIN、COS、TAN
- 对数函数：LOG、LN
- 统计函数：MAX、MIN、AVG
- 舍入函数：ROUND、CEILING、FLOOR

**自定义函数**：
- 支持用户定义函数
- 函数参数验证
- 函数结果缓存

### 2.3 条件判断 (judgeRelation)

**条件类型**：
- 数值比较条件
- 字符串匹配条件
- 逻辑组合条件
- 范围检查条件

**条件语法**：
```
@A > 10 AND @B = "OK"
@X BETWEEN 5 AND 15
@STATUS IN ("ACTIVE", "PENDING")
```

## 3. 数据处理模块

### 3.1 文件加载系统

#### CSV文件解析 (LoadFileToTBL)
**文件格式**：
- 逗号分隔值
- UTF-8编码
- 支持标题行

**数据验证**：
- 数据类型验证
- 数据范围检查
- 必填字段验证

#### 数据库操作 (LoadDbToTBL)
**支持的数据库**：
- Access数据库 (.mdb)
- SQL Server
- OLEDB数据源

**查询优化**：
- 参数化查询
- 查询结果缓存
- 连接池管理

### 3.2 数据搜索系统

#### 表搜索 (searchT_relation)
**搜索方式**：
- 精确匹配搜索
- 模糊匹配搜索
- 范围搜索
- 多条件组合搜索

**搜索优化**：
- 索引优化
- 搜索缓存
- 批量搜索

#### 类型定义搜索 (searchT_type_define)
**搜索逻辑**：
- 产品型号匹配
- 特征值提取
- 类型层次搜索

### 3.3 数据转换系统

#### 值转换 (searchT_ChngValue)
**转换类型**：
- 数值格式转换
- 单位转换
- 编码转换
- 映射表转换

#### 关系数据转换 (setRelationTBL)
**转换逻辑**：
- 一对一映射
- 条件映射
- 计算映射
- 级联映射

## 4. 用户交互模块

### 4.1 事件处理系统

#### 文本变更事件 (txt_change)
**处理流程**：
1. 文本内容验证
2. 数据格式转换
3. 相关控件更新
4. 计算触发

#### 按钮点击事件 (btn_input_Click)
**处理类型**：
- 计算器调用
- 数据提交
- 状态切换
- 界面导航

#### 组合框事件 (cmb_change)
**处理逻辑**：
- 选项选择验证
- 相关数据加载
- 界面状态更新

### 4.2 输入验证系统

#### 数值验证 (chkTxtIsNumeric)
**验证规则**：
- 数字格式检查
- 数值范围验证
- 小数点精度控制
- 负数支持

#### 业务规则验证 (chkAddControls)
**验证内容**：
- 数据完整性检查
- 业务逻辑验证
- 依赖关系检查
- 状态一致性验证

## 5. 通信模块

### 5.1 NC机床通信

#### 通信协议 (makeSendTxt)
**支持的协议**：
- Rexroth协议
- Brother协议
- 自定义协议

**消息格式**：
```python
# NC消息示例
"G01 X100 Y200 F500"
"M03 S1000"
```

#### 通信管理
**连接管理**：
- 串口通信
- 网络通信
- 通信状态监控

**错误处理**：
- 超时处理
- 重试机制
- 错误日志

### 5.2 进程间通信

#### 命名管道 (NamedPipeAsyncClient)
**通信方式**：
- 异步数据接收
- 实时数据推送
- 连接状态监控

**数据格式**：
- 文本数据
- 二进制数据
- 结构化数据

## 6. 系统管理模块

### 6.1 配置管理

#### INI配置 (setIni)
**配置内容**：
- 界面设置
- 计算参数
- 通信设置
- 系统参数

**配置验证**：
- 配置完整性检查
- 参数范围验证
- 依赖关系验证

#### 程序配置 (setPRG)
**程序管理**：
- 程序切换逻辑
- 程序参数设置
- 程序状态管理

### 6.2 界面管理

#### 控件状态管理 (setCntrlsEnable)
**状态控制**：
- 启用/禁用控制
- 可见性控制
- 只读控制

#### 焦点管理
**焦点控制**：
- 自动焦点设置
- 焦点循环
- 焦点丢失处理

### 6.3 定时器系统

#### 系统定时器 (Timer1_Tick)
**定时任务**：
- 界面状态更新
- 数据刷新
- 系统监控
- 自动保存

## 7. 数据模型设计

### 7.1 核心数据表

#### 程序数据表 (DSprg)
**表结构**：
- T_load: 加载数据表
- T_input: 输入数据表  
- T_measure: 测量数据表
- T_select: 选择数据表
- T_relation: 关系数据表
- T_switch: 开关数据表
- T_correct: 校正数据表
- T_calc: 计算数据表

#### 类型定义表
**表结构**：
- type_define: 类型定义
- type_relation: 类型关系
- type_chngvl: 类型变更值

### 7.2 数据关系

#### 一对一关系
- 程序与配置关系
- 控件与数据关系

#### 一对多关系
- 类型与特征关系
- 程序与参数关系

#### 多对多关系
- 条件关系
- 计算关系

## 8. 错误处理机制

### 8.1 异常分类

#### 数据异常
- 文件不存在错误
- 数据格式错误
- 数据验证错误

#### 计算异常
- 除零错误
- 表达式语法错误
- 数值溢出错误

#### 系统异常
- 内存不足错误
- 文件访问错误
- 通信错误

### 8.2 错误恢复

#### 自动恢复
- 数据备份恢复
- 配置重置
- 连接重试

#### 用户干预
- 错误提示
- 修复建议
- 手动恢复操作

## 9. 性能优化建议

### 9.1 数据访问优化

#### 缓存策略
- 数据表缓存
- 计算结果缓存
- 界面状态缓存

#### 懒加载
- 按需数据加载
- 延迟计算
- 动态控件创建

### 9.2 计算优化

#### 表达式优化
- 表达式预编译
- 变量替换优化
- 函数调用优化

#### 并行计算
- 多线程计算
- 批量处理
- 异步计算

---

*本文档为Python重构提供了完整的功能规格说明，确保新系统能够完全覆盖原有VB.NET系统的所有功能。*
