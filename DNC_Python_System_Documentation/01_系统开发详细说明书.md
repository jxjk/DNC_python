# DNC系统软件开发详细说明书

## 1. 系统概述

### 1.1 项目背景
DNC（Direct Numerical Control）系统是一个数控设备参数管理软件，用于从电脑直接传送参数到NC机的宏变量系统。该系统解决了传统NC机手动输入参数的时间和错误问题。

### 1.2 系统目标
- 实现产品型号的自动识别和处理
- 提供灵活的程序显示和切换机制
- 支持复杂的参数计算和验证
- 提高NC机参数设置的效率和准确性

### 1.3 系统架构
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   用户界面层     │    │   业务逻辑层     │    │   数据访问层     │
│                 │    │                 │    │                 │
│  - 主窗口       │◄──►│  - 型号识别     │◄──►│  - CSV处理器    │
│  - 程序显示     │    │  - 程序匹配     │    │  - 数据验证     │
│  - 参数输入     │    │  - 计算引擎     │    │  - 编码处理     │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 1.4 技术栈
- **开发语言**: Python 3.8+
- **UI框架**: PyQt5/PySide6
- **数据处理**: pandas
- **文件格式**: CSV
- **操作系统**: Windows 10/11

## 2. 型号识别模块详细设计

### 2.1 QR码识别模式

#### 2.1.1 Qrmode=0（固定字符删除模式）
**算法流程：**
1. 读取QR码字符串
2. 从字符串开头删除`BarCodeHeaderStrNum`定义的字数
3. 剩余字符串识别为型号

**配置参数（ini.csv）：**
- `BarCodeHeaderStrNum`: 需要删除的字符数（默认11）
- `QRmode`: 设置为0

**适用场景：**
- QR字符串格式：`PO@型号`
- 示例：`PO@C-CCC10-20A-P5-30` → 删除前11字符 → `C-CCC10-20A-P5-30`

#### 2.1.2 Qrmode=1（分隔符分割模式）
**算法流程：**
1. 读取QR码字符串
2. 使用`QRspltStr`定义的分隔符分割字符串
3. 取`MODELplc`指定位置的字符串作为型号

**配置参数（ini.csv）：**
- `QRmode`: 设置为1
- `QRspltStr`: 分隔符（默认"@"）
- `MODELplc`: 型号位置（默认2）
- `POplc`: PO位置（默认1）
- `QTYplc`: 数量位置（默认3）

**适用场景：**
- QR字符串格式：`PO@型号@数量`
- 示例：`PO@C-CCC10-20A-P5-30@100` → 分割后取第2个 → `C-CCC10-20A-P5-30`

### 2.2 型号分割处理

#### 2.2.1 分割规则
- 使用"-"字符分割型号字符串
- 示例：`C-CCC10-20A-P5-30` → `["C", "CCC10", "20A", "P5", "30"]`

#### 2.2.2 前缀处理（header.csv）
**配置格式：**
```csv
DEFINE,KIND
B,del
-,del
A,del
K,del
E,del
C,del
```

**处理逻辑：**
1. 检查分割后的第一个字符串
2. 如果在header.csv中定义为`del`，则删除该前缀
3. 示例：`C-CCC10` → 删除"C-" → `CCC10`

#### 2.2.3 内部定义规则
- 第一个以数字开头的字符串定义为`size1`
- 第二个以数字开头的字符串定义为`size2`
- 其他字符串保持原样

**示例处理结果：**
```
输入型号: C-CCC10-20A-P5-30
分割结果: ["C-CCC10", "20A", "P5", "30"]
内部定义: ["-", "size1", "-", "size2"]
最终型号: "CCC10-20A-P5-30"
```

## 3. 程序显示流程详细设计

### 3.1 型号匹配算法

#### 3.1.1 反向字符删除匹配
**算法流程：**
1. 从完整型号字符串开始
2. 从后向前逐个删除字符
3. 每次删除后在`type_define.csv`中搜索匹配的DEFINE项目
4. 找到第一个匹配项后停止

**匹配示例：**
```
搜索字符串: C-CCC10-20A-P5S-30
匹配过程:
C-CCC10-20A-P5S-30 → 无匹配
C-CCC10-20A-P5S-3 → 无匹配
C-CCC10-20A-P5S- → 无匹配
...
C-CCC → 匹配type_define.csv中NO=3的记录
```

#### 3.1.2 type_define.csv结构
```csv
NO,TYPE,DEFINE1,DEFINE2
1,AAA,define1-1,define1-2
2,AAA,define2-1,define2-2
3,C-CCC,,,
```

**匹配规则：**
- 当DEFINE1、DEFINE2为空时，不参照type_relation.csv、type_chngvl.csv
- 当DEFINE1、DEFINE2有值时，需要参照相关文件

### 3.2 程序顺序定义

#### 3.2.1 type_prg.csv结构
```csv
NO,prg1,prg2,prg3
1,1,2,3
2,3,2,1
3,2,3,1
```

**程序显示顺序：**
- 根据匹配的NO值，在type_prg.csv中找到对应的行
- 按照prg1、prg2、prg3的顺序显示程序
- 示例：NO=3 → 显示顺序：prg2 → prg3 → prg1

#### 3.2.2 prg.csv程序定义
```csv
PRGNO,PRGNAME,PRGTEXT
1,prg1,abc1
2,prg2,abc2
3,prg3,abc3
```

### 3.3 程序参数加载

#### 3.3.1 load.csv结构
```csv
NO,TYPE,DRAWING,DISPFLG,#500,#501,#502,#503,#504,#505,#506,#507,#508,#509
1,AAA,test1.jpg,1,10,size1,define1-1,define1-2,5,measure1,select1,relation1,switch1,correct1
2,AAA,test1.jpg,1,20,size1,define2-1,define2-2,5,measure1,select2,relation2,switch1,correct1
3,C-CCC,test1.jpg,1,30,size1,define3-1,define3-2,5,measure1,select3,relation3-3,switch1,correct3
```

**字段说明：**
- `DRAWING`: 图纸文件路径
- `DISPFLG`: 显示标志（1=显示，0=不显示）
- `#500-#509`: 宏变量定义

#### 3.3.2 cntrl.csv控制定义
```csv
MACRO,KIND,DISPFLG,SENDFLG,AUTOSENDFLG,BTNNAME,CHANGEPRG,LABELTXT,MIN,MAX,CMNT_B,CMNT_R
#500,load,1,1,0,,,,
#501,load,1,1,0,,,,
#502,load,1,1,0,,,,
#503,load,1,1,0,,,,
#504,input,1,1,1,角A,,,,
#505,measure,1,1,1,,,,,
#506,select,1,1,0,,,,
#507,relation,1,1,0,,,,
#508,switch,1,1,1,,,,
#509,correct,1,1,0,,,,
```

**控件类型说明：**
- `load`: 只读显示
- `input`: 可输入文本框
- `measure`: 测量值输入
- `select`: 下拉选择框
- `relation`: 关系验证
- `switch`: 开关按钮
- `correct`: 修正值输入

## 4. 计算引擎详细设计

### 4.1 多层计算逻辑

#### 4.1.1 define.csv变量定义
```csv
DEFINE,STR,BEFORE,AFTER,CHNGVL,CALC
define3-1,C-CCC,C-CCC,,,
define3-2,P,P0,0,chngS,
define3-2,P,P1,1,chngS,
define3-2,P,P2,2,chngS,
define3-2,P,P3,3,chngS,
define3-2,P,P4,4,chngS,
define3-2,P,P5,5,chngS,calc2-2
define3-2,P,P6,6,chngS,
define3-2,P,P7,7,chngS,
define3-2,P,P8,8,chngS,
define3-2,P,P9,9,chngS,
define3-2,P,-,0,,,
```

**处理逻辑：**
1. 在分割字符串中查找以STR开头的字符串
2. 将BEFORE值替换为AFTER值
3. 如果有CHNGVL定义，继续在chngValue.csv中处理
4. 如果有CALC定义，继续在calc.csv中计算

#### 4.1.2 chngValue.csv值转换
```csv
DEFINE,BEFORE,AFTER
chngS,S,1
```

**处理逻辑：**
- 将输入值中的BEFORE替换为AFTER
- 示例：`5S` → `S`替换为`1` → `51`

#### 4.1.3 calc.csv计算定义
```csv
DEFINE,1,2,3,4,5,6,7,8,9,10
calc2-2,=,calc2-2,+,1,,,,,,,
```

**计算逻辑：**
- 支持四则运算和函数计算
- 示例：`calc2-2 = calc2-2 + 1` → `51 + 1 = 52`

### 4.2 测量值处理

#### 4.2.1 measure.csv定义
```csv
DEFINE,LABELVALUE,DEFVALUE,SENDVALUE
measure1,卡尺值,0,relation10
```

**字段说明：**
- `LABELVALUE`: 显示标签
- `DEFVALUE`: 默认值
- `SENDVALUE`: 发送值（支持关系验证）

#### 4.2.2 relation.csv关系验证
```csv
DEFINE,VALUE,1,2,3,4,5,6,7,8
relation10,1,and,#505M,>=,0,and,#505M,<=,1
relation10,#505M,and,#505M,>,1
```

**验证逻辑：**
- 当`#505M >= 0 and #505M <= 1`时，显示1
- 当`#505M > 1`时，显示测量值本身

### 4.3 选择控件处理

#### 4.3.1 select.csv定义
```csv
DEFINE,DISPVALUE,SENDVALUE
select3,test1-1,1
select3,test1-2,2
```

**显示逻辑：**
- 下拉列表显示`DISPVALUE`
- 选择后发送`SENDVALUE`

### 4.4 开关控件处理

#### 4.4.1 switch.csv定义
```csv
DEFINE,DISPVALUE,SENDVALUE
switch1,test1,1
switch1,test2,2
switch1,test3,3
```

**交互逻辑：**
- 初始显示第一个选项
- 每次点击切换到下一个选项

### 4.5 修正值处理

#### 4.5.1 correct.csv定义
```csv
DEFINE,DEFVALUE,UPDWN,UPPER,LOWER
correct3,1,0.5,10,0
```

**参数说明：**
- `DEFVALUE`: 默认值
- `UPDWN`: 每次增减的值
- `UPPER`: 上限值
- `LOWER`: 下限值

## 5. 数据结构和文件格式

### 5.1 核心配置文件

#### 5.1.1 ini.csv（系统配置）
```csv
DEFINE,VALUE
BarCodeHeaderStrNum,11
QRmode,1
QRspltStr,@
MODELplc,2
POplc,1
QTYplc,3
```

#### 5.1.2 header.csv（前缀处理）
```csv
DEFINE,KIND
B,del
-,del
A,del
```

### 5.2 程序定义文件

#### 5.2.1 type_define.csv（型号定义）
- 文件大小：~1MB
- 关键字段：NO, TYPE, DEFINE1, DEFINE2

#### 5.2.2 type_prg.csv（程序映射）
- 文件大小：~500KB
- 关键字段：NO, prg1, prg2, prg3

#### 5.2.3 prg.csv（程序信息）
- 文件大小：小文件
- 关键字段：PRGNO, PRGNAME, PRGTEXT

### 5.3 程序参数文件

#### 5.3.1 load.csv（参数加载）
- 文件大小：~8.5MB
- 关键字段：NO, TYPE, DRAWING, DISPFLG, #500-#509

#### 5.3.2 cntrl.csv（控件定义）
- 文件大小：~1KB
- 关键字段：MACRO, KIND, DISPFLG, SENDFLG, AUTOSENDFLG, BTNNAME

### 5.4 计算相关文件

#### 5.4.1 define.csv（变量定义）
- 关键字段：DEFINE, STR, BEFORE, AFTER, CHNGVL, CALC

#### 5.4.2 chngValue.csv（值转换）
- 关键字段：DEFINE, BEFORE, AFTER

#### 5.4.3 calc.csv（计算逻辑）
- 关键字段：DEFINE, 1-10（计算表达式）

#### 5.4.4 relation.csv（关系验证）
- 关键字段：DEFINE, VALUE, 1-28（条件表达式）

## 6. 用户界面设计

### 6.1 主界面布局

```
┌─────────────────────────────────────────────┐
│ 标题栏：DNC系统 v2.0                        │
├─────────────────────────────────────────────┤
│ 型号显示：[C-CCC10-20A-P5S-30]              │
├───────────────┬─────────────────────────────┤
│  图纸显示区   │       参数显示区             │
│               │  ┌─────────────────────┐    │
│  [test1.jpg]  │  │ #500: 30            │    │
│               │  │ #501: size2(30)     │    │
│               │  │ #502: 10            │    │
│               │  │ #503: 52            │    │
│               │  │ #504: [5] 角A       │    │
│               │  │ #505: [卡尺值]      │    │
│               │  │ #506: [test1-1▼]    │    │
│               │  │ #507: [关系验证]    │    │
│               │  │ #508: [test1▼]      │    │
│               │  │ #509: [1±]          │    │
│               │  └─────────────────────┘    │
├───────────────┴─────────────────────────────┤
│ 程序切换：[prg2] [prg3] [prg1] 发送：[发送] │
└─────────────────────────────────────────────┘
```

### 6.2 控件类型设计

#### 6.2.1 load控件（只读显示）
- 显示格式：标签 + 值
- 示例：`#500: 30`

#### 6.2.2 input控件（文本输入）
- 显示格式：文本框 + 按钮名称
- 示例：`[5] 角A`

#### 6.2.3 measure控件（测量值）
- 显示格式：标签 + 输入框
- 示例：`[卡尺值]`

#### 6.2.4 select控件（下拉选择）
- 显示格式：下拉列表
- 示例：`[test1-1▼]`

#### 6.2.5 relation控件（关系验证）
- 显示格式：只读文本框
- 示例：`[关系验证]`

#### 6.2.6 switch控件（开关按钮）
- 显示格式：下拉按钮
- 示例：`[test1▼]`

#### 6.2.7 correct控件（修正值）
- 显示格式：数值框 + 增减按钮
- 示例：`[1±]`

### 6.3 交互逻辑

#### 6.3.1 程序切换
- 点击程序按钮切换到对应程序
- 重新加载对应程序的load.csv配置
- 更新界面显示

#### 6.3.2 参数发送
-
